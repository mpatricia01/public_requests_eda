---
title: "University of Illinois - Urbana-Champaign"
urlcolor: blue
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    fig_caption: true
    highlight: tango
    theme: default
    df_print: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(tibble.width = Inf, width = 10000, scipen = 999)

library(tidyverse)
library(readxl)
library(lubridate)
library(leaflet)
library(rgdal)
# library(raster)
library(formattable)
library(scales)
library(htmlwidgets)
```

<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>

```{r}
# Load data

zip_cbsa_data <- read_csv(url('https://raw.githubusercontent.com/cyouh95/third-way-report/master/assets/data/zip_code_cbsa.csv'))
hs_data <- read_csv(url('https://github.com/cyouh95/third-way-report/blob/master/assets/data/hs_data.csv?raw=true'), col_types = c('zip_code' = 'c'))

ceeb_nces <- read_csv(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/ceeb_nces_crosswalk.csv'))
cds_nces <- read_csv(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/CDS_NCES_crosswalk.csv')) %>% 
  mutate(ncessch = str_c(NCESDist, NCESSchool))

load(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/145637_orders.RData'))
# Contains: IL_orders, OOS_orders, OOS_eng_orders, OOS_noneng_orders, intl_orders,
#           lists_df_pivot, lists_df_sat, lists_df_act, df_sat_ca_20, df_sat_ca_19

# Add 11 + 12 columns for the SAT test takers datasets
add_testtakers_cols <- function(sat_df) {
  sat_df %>% mutate(
    Enroll1112 = as.numeric(Enroll12) + as.numeric(Enroll11),
    NumTSTTakr1112 = NumTSTTakr11 + NumTSTTakr12,
    NumERWBenchmark1112 = as.numeric(NumERWBenchmark11) + as.numeric(NumERWBenchmark12),
    PctERWBenchmark1112 = as.numeric(NumERWBenchmark1112) / as.numeric(NumTSTTakr1112),
    NumMathBenchmark1112 = as.numeric(NumMathBenchmark11) + as.numeric(NumMathBenchmark12),
    PctMathBenchmark1112 = as.numeric(NumMathBenchmark1112) / as.numeric(NumTSTTakr1112),
    TotNumBothBenchmark1112 = as.numeric(TotNumBothBenchmark11) + as.numeric(TotNumBothBenchmark12),
    PctBothBenchmark1112 = as.numeric(TotNumBothBenchmark1112) / as.numeric(NumTSTTakr1112)
  )
}

df_sat_ca_20 <- add_testtakers_cols(df_sat_ca_20)
df_sat_ca_19 <- add_testtakers_cols(df_sat_ca_19)
```

# Illinois purchases (51 orders)

```{r}
IL_orders
```

Generally, on each purchase date, they make **6 IL orders by race/ethnicity and test scores**:

- Race/ethnicity groups (A) + Test score range (low A)
- Race/ethnicity groups (A) + Test score range (med A)
- Race/ethnicity groups (A) + Test score range (high A)
- Race/ethnicity groups (B) + Test score range (low B)
- Race/ethnicity groups (B) + Test score range (med B)
- Race/ethnicity groups (B) + Test score range (high B)

**Group/filter definitions**:

- **Race/ethnicity groups (A)**
  - Asian (including Indian subcontinent and Philippines origin)|Other|I do not wish to respond to race|No, not of Hispanic, Latino, or Spanish origin|White (including Middle Eastern origin)|Native Hawaiian or Other Pacific Islander
    - Starting from **Fall 2019**, they removed "_Native Hawaiian or Other Pacific Islander_" from the **med** and **high** orders
    - In the most recent 2 rounds of purchases (**6 orders** from **Dec 2019** & **Apr 2020**), they further limited geographic filter to 12 specific metro areas within IL
  - **Test score range (low A)**: 1160 - 1270
  - **Test score range (med A)**: 1260/1280 - 1440
  - **Test score range (high A)**: 1450 - 1600
- **Race/ethnicity groups (B)**
  - Black or African American|American Indian or Alaska Native|Other Hispanic or Latino|Puerto Rican|Mexican|Hispanic or Latino (including Spanish origin)|Cuban
    - Starting from **Fall 2019**, they added "_Native Hawaiian or Other Pacific Islander_" to all orders (**low**, **med**, and **high**)
  - **Test score range (low B)**: 1020/1030 - 1190
  - **Test score range (med B)**: 1200 - 1350/1380
  - **Test score range (high B)**: 1360/1390 - 1600
  
**Common filters**:

- **GPA**: A+ to B-
- **Class rank**: Highest tenth to second fifth

<iframe src="https://cyouh95.github.io/third-way-report/assets/maps/public_requests/map_IL.html" width="100%" height="800px"></iframe>


# Out-of-states purchases (22 orders)

Based on geographic filters, we can categorize their orders into **3 broad categories**:

- Specific MSAs (3 orders)
- Non-engineering majors in specific MSAs + CA, CT, MO, and Armed Forces military districts (6 orders)
- Engineering majors in all 49 states except IL + DC (13 orders)

21 of the 22 out-of-state orders also use these [segment analysis](http://secure-media.collegeboard.org/mSSS/media/pdf/segment-analysis-service-overview.pdf) filters (total possible: _33 neighborhood clusters_ and _29 high-school clusters_):

- **EN**:51, **HS**:65 | **EN**:51, **HS**:68 | **EN**:51, **HS**:70 | **EN**:51, **HS**:79 
- **EN**:53, **HS**:65 | **EN**:53, **HS**:70 | 
- **EN**:58, **HS**:64 | **EN**:58, **HS**:65 | **EN**:58, **HS**:70
- **EN**:60, **HS**:65 | **EN**:60, **HS**:68 | **EN**:60, **HS**:70 | **EN**:60, **HS**:79 
- **EN**:61, **HS**:ALL 
- **EN**:63, **HS**:65 | **EN**:63, **HS**:70
- **EN**:69, **HS**:68 | **EN**:69, **HS**:70 | **EN**:69, **HS**:75 
- **EN**:70, **HS**:66 | **EN**:70, **HS**:68 | **EN**:70, **HS**:70 | **EN**:70, **HS**:79 
- **EN**:73, **HS**:65 | **EN**:73, **HS**:70 
- **EN**:78, **HS**:ALL

Sample **neighborhood clusters (EN)** characteristics from 2011:

![](https://github.com/cyouh95/third-way-report/raw/master/assets/maps/public_requests/EN.png)

Sample **high school clusters (HS)** characteristics from 2011:

![](https://github.com/cyouh95/third-way-report/raw/master/assets/maps/public_requests/HS.png)

## MSA orders (3 orders)  
```{r}
OOS_msa_orders <- OOS_orders %>% filter(order_num %in% c('500590', '567376', '483751'))

OOS_msa_orders
```

They made **2** "OOS Regional MSA" orders **1** "Regional Counselor MSAs" order.  

- They used the segment analysis from above
- A+/B- high school GPA
- MSAs from states: CA, TX, GA, FL, NY, NJ

<iframe src="https://cyouh95.github.io/third-way-report/assets/maps/public_requests/map_OOS_regional_msa.html" width="100%" height="800px"></iframe>

### Student-level MSA specific orders  

```{r include=FALSE}
#Prep data

# Directory paths
data_dir <- file.path('..', 'data')
plots_dir <- file.path('..', 'outputs', 'plots')
maps_dir <- file.path('..', 'outputs', 'maps')

# Read in data
lists_df <- read_csv(file.path(data_dir, '145637_lists.csv'), col_types = cols(.default = 'c'))
orders_df <- read_csv(file.path(data_dir, '145637_orders.csv'), col_types = c('univ_id' = 'c', 'order_num' = 'c'))

# Checks
#str_detect(lists_df$Source, '^(?:\\w+ \\d+, \\d{4} [SACT]{3} Search \\d+;?\\s*)+$') %>% table()
#str_count(lists_df$Source, 'SAT|ACT') %>% sum()  # 465231 matches number of rows in lists_df_pivot

# https://cathblatter.rbind.io/blog/2020/03/16/using-pivot-longer-and-regex-for-data-wrangling/
lists_df_pivot <- lists_df %>% 
  pivot_longer(
    cols = starts_with(c('sat_', 'act_')),
    names_to = c('.value', 'test_num'),
    names_pattern = '(^\\w+)_(\\d+)'
  ) %>%
  dplyr::select(-test_num) %>% 
  pivot_longer(
    cols = starts_with(c('sat_', 'act_')),
    names_to = c('test_type', '.value'),
    names_sep = '_',
    values_drop_na = T
  ) %>%
  rename(order_num = test, order_date = date) %>% 
  mutate(order_date = mdy(order_date))

# SAT orders
lists_df_sat <- lists_df_pivot %>% filter(test_type == 'sat')

# Missing order summary for 107713 of 415689 rows in lists_df_sat (15 distinct orders)
#anti_join(lists_df_sat, orders_df, by = 'order_num') %>% nrow()
#View(anti_join(lists_df_sat, orders_df, by = 'order_num') %>% dplyr::select(order_num, order_date) %>% distinct())

# 3 order summaries w/ no lists entries, but these look like draft orders that weren't actually placed (i.e., "Edit name")
#View(anti_join(orders_df, lists_df_sat, by = 'order_num'))

# Explore remaining matched rows (rows may be duplicates if they belong to multiple orders)
merged_df_sat <- inner_join(lists_df_sat, orders_df, by = 'order_num')

#Run some descriptive statistics
merged_df_sat %>% group_by(order_num) %>% count() #about 77 order summaries

#Out-of-state orders, MSA specific criteria
OOS_msa_stu <- merged_df_sat %>% filter(order_num %in% c('500590', '567376', '483751'))
```

Number of students purchased in the three orders  

```{r}
OOS_msa_stu %>% count(order_num) %>% arrange(-n)
```


It appears that 4 students might of been purchased twice
```{r}
OOS_msa_stu %>%
  group_by(Ref, order_num) %>%
  summarize(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)

OOS_msa_stu %>%
  group_by(Ref, order_num) %>%
  summarize(n_per_grp = n()) %>%
  ungroup() %>%
  filter(n_per_grp > 1) #4 students were purchased twice

```

```{r include=FALSE}
#============================================================================
#Student lists investigations of MSA specific orders
#============================================================================
# View(OOS_msa_stu %>%
#        filter(Ref %in% c(058607977, 	
# 	058918440, 313230561, 964290266)) %>%
#   dplyr::select(Ref:SchoolCode, order_num)) #not all are showing up?

#check how many schools are purchased more than once
OOS_msa_stu %>%
  group_by(SchoolCode) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)

OOS_msa_stu %>%
  group_by(SchoolCode) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  filter(n_per_grp > 1) %>%
  arrange(-n_per_grp)

#check unique schools
length(unique(OOS_msa_stu$SchoolCode)) #2455
  

OOS_msa_stu %>%
  group_by(ZipCode) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  filter(n_per_grp>1) %>% arrange(-n_per_grp)


```

```{r include=FALSE}
#---------------
# Merge census data with student-level data by zip code
#---------------

#read in zip-code level census data
zip_data <- read_csv(url('https://raw.githubusercontent.com/cyouh95/third-way-report/master/assets/data/zip_to_state.csv'))

#have to create a 5-digit zip code variable
OOS_msa_stu %>%
  mutate(zip_code = str_extract(ZipCode, "\\d{5}")) %>%
  dplyr::select(zip_code, ZipCode)

OOS_msa_stu <- OOS_msa_stu %>%
  mutate(zip_code = str_extract(ZipCode, "\\d{5}"))
  
#unique zipcodes
OOS_msa_stu %>%
  group_by(Ref, ZipCode) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  filter(n_per_grp>0) %>% arrange(-n_per_grp)

length(unique(OOS_msa_stu$zip_code)) #2427 unique zip codes

#join student-level & census data
OOS_msa_census <- OOS_msa_stu %>% left_join(zip_data, by = "zip_code")

OOS_msa_census %>%
  filter(zip_code != `zip_code(2)`)

#check merge
anti_msa_census <- OOS_msa_stu %>% anti_join(zip_data, by = "zip_code")
```

```{r include=FALSE}
#general investigations
OOS_msa_census %>%
  group_by(zip_code) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)

#zip codes where students are purchased, sort by ascending
OOS_zips <- OOS_msa_census %>%
  group_by(zip_code) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  filter(n_per_grp > 0) %>% arrange(-n_per_grp)

#merge census data to zip code data
OOS_msa_zip <- OOS_zips %>% left_join(zip_data, by = "zip_code")

```

```{r include=FALSE}
#investigate zip codes 

#create race/ethnicity pct variables
OOS_msa_zip <- OOS_msa_zip %>%
  mutate(pct_black = pop_black/pop_total,
         pct_white = pop_white/pop_total,
         pct_asian = pop_asian/pop_total,
         pct_latinx = pop_hispanic/pop_total,
         pct_nat_am = pop_amerindian/pop_total,
         pct_nat_hi = pop_nativehawaii/pop_total,
         pct_two_races = pop_tworaces/pop_total,
         pct_other = pop_otherrace/pop_total)

#check
OOS_msa_zip %>%
  mutate(pct_tot = round(pct_black + pct_white + pct_asian + pct_latinx + pct_nat_am + pct_nat_hi + pct_other + pct_two_races)) %>%
  dplyr::select(pct_tot, pct_black, pct_white, pct_asian, pct_latinx, pct_nat_am, pct_nat_hi, pct_other, pct_two_races) %>%
  filter(pct_tot != 1)

```

This table below shows the number of zip codes purchased by descending order 

- Grouped by zip code and summarized to get a count of the number of students purchased within each zip code
- Merged in census zip-code level data to show demographic data associated with each zip code  

```{r}
OOS_msa_zip %>%
  dplyr::select(zip_code, n_per_grp, median_household_income, starts_with("pct"))
```


```{r include=FALSE}
#grab top 5 zip codes
top_five_zip <- head(OOS_msa_zip$zip_code,5)

#filter msa/census df of top 5 zip codes
OOS_msa_top_5_zip <- OOS_msa_census %>%
  filter(zip_code %in% top_five_zip)

OOS_msa_top_5_zip %>%
  filter(zip_code == "77494") %>%
  dplyr::select(Ref:State, GeoMarket, Race, Hispanic, order_num, cbsa_name, segment) #%>% #565
  #filter(Race == "White" & (is.na(Hispanic) | Hispanic == "No")) #172 non-hispanic white about 30% of purchases from this zip code
  #filter(Race == "Black or African American" & (is.na(Hispanic) | Hispanic == "No")) #about 26 Black non-hispanic, about 5% of purchases from this zip code
  #filter(Race == "White" & (!is.na(Hispanic) | Hispanic == "Yes")) #about 75 Latinx students, about 13% of purchases from this zip code
  #filter(Race == "Asian" & (is.na(Hispanic) | Hispanic == "No")) #about 232 Asian students purchased, about 41% of purchases from this zip code

#create race/ethnicity student-level variables
OOS_msa_top_5_zip %>%
  group_by(Race) %>%
  summarise(n_per_grp = n()) 

OOS_msa_top_5_zip %>%
  filter(Hispanic == "Yes")

OOS_msa_top_5_zip <- OOS_msa_top_5_zip %>%
  group_by(zip_code) %>%
  #dplyr::select(Ref:State, GeoMarket, Race, Hispanic, order_num, cbsa_name, segment) %>% #565
  mutate(white = ifelse(Race == "White" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         black = ifelse(Race == "Black or African American" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         asian = ifelse(Race == "Asian" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         latinx = ifelse((!is.na(Hispanic) & Hispanic == "Yes"),1,0),
         nhpi = ifelse(Race == "Native Hawaiian or Other Pacific" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         nat_am = ifelse(Race == "American Indian or Alaska Native" &
                           (is.na(Hispanic) | Hispanic == "No"),1,0),
         none = ifelse(is.na(Race) & (is.na(Hispanic) | Hispanic == "No"),1,0),
         stu_pct_white = mean(white, na.rm=TRUE), #pct race/ethnicty for student-level data
         stu_pct_black = mean(black, na.rm=TRUE),
         stu_pct_asian = mean(asian, na.rm=TRUE),
         stu_pct_latinx = mean(latinx, na.rm=TRUE),
         stu_pct_nhpi = mean(nhpi, na.rm=TRUE),
         stu_pct_natam = mean(nat_am, na.rm=TRUE),
         stu_pct_none = mean(none, na.rm=TRUE),
         pct_black = pop_black/pop_total, #pct race/ethnicity for census data
         pct_white = pop_white/pop_total,
         pct_asian = pop_asian/pop_total,
         pct_latinx = pop_hispanic/pop_total,
         pct_nat_am = pop_amerindian/pop_total,
         pct_nat_hi = pop_nativehawaii/pop_total,
         pct_two_races = pop_tworaces/pop_total,
         pct_other = pop_otherrace/pop_total)
  
  
  
#sum(OOS_msa_top_5_zip$latinx, na.rm=T)
#sum(OOS_msa_top_5_zip$Hispanic=="Yes", na.rm=T)

#OOS_msa_top_5_zip %>%
#  dplyr::select(Race, Hispanic, latinx)
```

Filtered to the top five zip codes purchased

- Calculated the race/ethnicity for students purchased by zip code to create percent race/ethnicity variables  

Zip code `77494`  

- Filtered to the zip code `77494` to compare the racial/ethnic composition of students purchased in this zip code and the racial/ethnic composition of the population of this zip code

```{r}
OOS_msa_77494_zip <- OOS_msa_top_5_zip %>%
  filter(zip_code == "77494") %>%
  dplyr::select(zip_code, stu_pct_white, pct_white, stu_pct_black, pct_black, stu_pct_asian, pct_asian, stu_pct_latinx, pct_latinx, stu_pct_nhpi, pct_nat_hi, stu_pct_natam, pct_nat_am) %>% head(n=1)

OOS_msa_77494_zip
```

Zip code `77479`  

- Filtered to the zip code `77479` to compare the racial/ethnic composition of students purchased in this zip code and the racial/ethnic composition of the population of this zip code

```{r}
OOS_msa_77479_zip <- OOS_msa_top_5_zip %>%
  filter(zip_code == "77479") %>%
  dplyr::select(zip_code, stu_pct_white, pct_white, stu_pct_black, pct_black, stu_pct_asian, pct_asian, stu_pct_latinx, pct_latinx, stu_pct_nhpi, pct_nat_hi, stu_pct_natam, pct_nat_am) %>% head(n=1)

OOS_msa_77479_zip
```

Zip code `94582`   

- Filtered to the zip code `94582` to compare the racial/ethnic composition of students purchased in this zip code and the racial/ethnic composition of the population of this zip code

```{r}
OOS_msa_94582_zip <- OOS_msa_top_5_zip %>%
  filter(zip_code == "94582") %>%
  dplyr::select(zip_code, stu_pct_white, pct_white, stu_pct_black, pct_black, stu_pct_asian, pct_asian, stu_pct_latinx, pct_latinx, stu_pct_nhpi, pct_nat_hi, stu_pct_natam, pct_nat_am) %>% head(n=1)

OOS_msa_94582_zip
```

Zip code `77382`   

- Filtered to the zip code `77382` to compare the racial/ethnic composition of students purchased in this zip code and the racial/ethnic composition of the population of this zip code

```{r}
OOS_msa_77382_zip <- OOS_msa_top_5_zip %>%
  filter(zip_code == "77382") %>%
  dplyr::select(zip_code, stu_pct_white, pct_white, stu_pct_black, pct_black, stu_pct_asian, pct_asian, stu_pct_latinx, pct_latinx, stu_pct_nhpi, pct_nat_hi, stu_pct_natam, pct_nat_am) %>% head(n=1)

OOS_msa_77382_zip
```

Zip code `30024`  

- Filtered to the zip code `30024` to compare the racial/ethnic composition of students purchased in this zip code and the racial/ethnic composition of the population of this zip code

```{r}
OOS_msa_30024_zip <- OOS_msa_top_5_zip %>%
  filter(zip_code == "30024") %>%
  dplyr::select(zip_code, stu_pct_white, pct_white, stu_pct_black, pct_black, stu_pct_asian, pct_asian, stu_pct_latinx, pct_latinx, stu_pct_nhpi, pct_nat_hi, stu_pct_natam, pct_nat_am) %>% head(n=1)

OOS_msa_30024_zip
```


## Non-ENG orders (6 orders)

```{r}
OOS_noneng_orders
```

They made **5** "OOS Non-ENG" orders & **1** "OOS ENG and Non-ENG" order between **Feb 2018** & **Jun 2019** w/ the criteria:

- Specific MSAs + CA, CT, MO, and Armed Forces military districts
- Above segment analysis filter for the **5** Non-ENG only orders but not the 1 order that included ENG majors too
- A+ to B- high school GPA
- SAT score of 1230/1240 - 1450 or PSAT score of 1220/1230/1240 - 1450
  - The **1** ENG & Non-ENG order had criteria of SAT 1240 - 1450 or PSAT 1220 - 1450

<iframe src="https://cyouh95.github.io/third-way-report/assets/maps/public_requests/map_OOS_nonENG.html" width="100%" height="800px"></iframe>

## ENG orders (13 orders)

```{r}
OOS_eng_orders

# Lower test score criteria for female students
OOS_eng_orders %>% dplyr::select(gender, sat_score_min, sat_score_max, psat_score_min, psat_score_max) %>%
  distinct() %>% arrange(sat_score_min)

# Fewer female students purchased
OOS_eng_orders %>% group_by(gender) %>%
  summarise(num_orders = n(), total_cost = sum(order_cost), total_students = sum(num_students))
```

They made **6** "OOS ENG Male" orders & **7** "OOS ENG Female" orders between **Feb 2018** & **Apr 2020** w/ the criteria:

- All 49 states except IL + DC
- Above segment analysis filter 
- A+ to B- high school GPA
- SAT/PSAT score filter which differs by gender

**General observations**:

- More purchases made for female students and w/ lower test score criteria, but resulting female engineering majors in list still less than total male students


# International purchases (4 orders)

```{r}
intl_orders
```


They made **4** international orders between **May 2018** & **June 2019** with the following search criteria:  

- All filter for A+/B- high school GPA
- SAT/PSAT scores vary by country.  
```{r}
intl_orders %>% dplyr::select(order_title, order_num, num_students, sat_score_min, sat_score_max, psat_score_min, psat_score_max)
```


# CA HS SAT EDA

```{r}
la_zip_codes <- (zip_cbsa_data %>% filter(cbsa_1 == '31080'))$zip_code

# Look at just College Board LA students
lists_df_sat_la <- lists_df_sat %>%
  select(-test_type, -order_num, -order_date) %>% distinct() %>%  # Each student is unique - got rid of duplicates that came from multiple orders
  mutate(
    zip_code = str_pad(str_sub(ZipCode, 1, 5), width = 5, pad = '0', side = 'left'),
    ceeb = str_pad(SchoolCode, width = 6, pad = '0', side = 'left'),
    is_white = as.integer(str_detect(Race, 'White'))
  ) %>% 
  filter(zip_code %in% la_zip_codes)
```

```{r}
length(unique(lists_df_sat_la$zip_code))  # 307 zip codes in LA
length(unique(lists_df_sat_la$ceeb))  # 348 HS in LA

# Group by HS
lists_df_sat_la_hs <- lists_df_sat_la %>%
  group_by(ceeb) %>% 
  summarise(total_students_purchased = n(), pct_white_purchased = mean(is_white, na.rm = T) * 100) %>% 
  arrange(-total_students_purchased) %>%
  left_join(ceeb_nces, by = 'ceeb') %>% 
  left_join(cds_nces %>% select(ncessch, CDSCode), by = 'ncessch') %>% 
  left_join(hs_data %>% select(ncessch, total_students, pct_white), by = 'ncessch') %>% 
  left_join(df_sat_ca_20, by = c('CDSCode' = 'CDS'))

lists_df_sat_la_hs
```


**Available variables**:

- **Student lists**
  - `total_students_purchased`
  - `pct_white_purchased`
- **NCES HS data**
  - `total_students`
  - `pct_white`
- **CA DOE data**
  - 12th graders: `Enroll12` (_enrolled_), `NumTSTTakr12` (_# of testtakers_), `NumERWBenchmark12` (_# met english benchmark_), `NumMathBenchmark12` (_# met math benchmark_)
  - 11th graders: `Enroll11`, `NumTSTTakr11`, `NumERWBenchmark11`, `NumMathBenchmark11`
  - 12th + 11th graders: `Enroll1112`, `NumTSTTakr1112`, `NumERWBenchmark1112`, `NumMathBenchmark1112`

**Possible analysis**:

- Compare high school's racial composition & test readiness against actual purchased students
- Ideally, we'd be able to isolate purchased students by grad year/grade to match with secondary data for the same class of students
  - We weren't able to do it for Urbana because some orders filtered for multiple graduating classes and there's no grad_class column in the student-level data - that could be something we can try to request for
  - We'll also need to update NCES data (e.g., different year's data, use race variables by grade level) and check crosswalk

**Potential questions/concerns**:

- If the characteristics of purchased students (e.g., racial composition, test readiness) do indeed differ from that of the high school for the same cohort/class of students, what are we able to conclude about why that is?
  - We will need to look at the order summary criteria to see what filters were being used
  - In the case of Urbana, the out-of-state orders filtered by geography (state, MSA, segment analysis), SAT/PSAT score ranges, and HS GPA (and sometimes separate orders for gender but both male/female were purchased)
  - In theory, all students who took the SAT who met the test score/GPA criteria and attended a HS that falls within the purchased geography/segment should be on the list
  - If a student from a purchased HS is not on the list, they either did not take the SAT/opt in or did not meet the test/GPA criteria
- In other words, Urbana could not specifically pick students from the high school (apart from the filter criteria used), but they are specifically picking high schools to purchase through the segment analysis filter
  - It would be ideal to know the characteristics of the EN/HS clusters being purchased as compared to the clusters not purchased
  - We could try to look at purchased student-level data to infer characteristics of purchased EN/HS clusters, but without knowing the nonpurchased students, it would be hard to make comparisons/draw conclusions
  - Ideally we would be able to request the segment analysis info from the University


```{r include=FALSE}
# read in student list df of CA student purchases
df_sl_ca <- read_csv("../data/145637_list_ca.csv")

# read in 2018-2019 & 2019-2020 CA DOE data
df_sat_ca_20 <- read_xlsx("../data/sat20.xlsx", na = c('N/A', '*'))  
df_sat_ca_19 <- read_xlsx("../data/sat19.xlsx", na = c('N/A', '*'), skip = 5)

# read in acs race variables for ages 15-19
acs_race_zipcode <- read_csv("../data/acs_race_zipcode.csv")

#subset to only california zipcodes
acs_race_ca_zipcode <- acs_race_zipcode %>%
  filter(state_fips_code == 6)

#read in nces hs data
hs_data <- read_csv(url('https://github.com/cyouh95/third-way-report/blob/master/assets/data/hs_data.csv?raw=true'), col_types = c('zip_code' = 'c')) %>% 
  mutate(pct_poc = pct_black + pct_hispanic + pct_amerindian)

hs_ca_data <- hs_data %>%
  filter(state_code == "CA")

df_sl_ca <- df_sl_ca %>%
  group_by(ncessch) %>%
  mutate(n_stu_nces = n()) %>%
  ungroup() 

# merge DOE to CA student list data
df_sl_sat_CA <- df_sl_ca %>% rename(CDS=CDSCode) %>% left_join(df_sat_ca_19, by = "CDS")

# merge NCES to CA student list & DOE data
df_sl_hs_sat_CA <- df_sl_sat_CA %>% left_join(hs_ca_data, by = "ncessch")

# Subset to LA county schools only
df_la_county <- df_sl_hs_sat_CA %>% filter(CName == "Los Angeles")

#df_la_county
```

```{r include=FALSE}
df_la_county <- add_testtakers_cols(df_la_county)

df_sl_la_race <- df_la_county %>%
  group_by(ncessch) %>%
  filter(!is.na(ncessch), !is.na(CDS)) %>%
  mutate(white = ifelse(Race == "White" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         black = ifelse(Race == "Black or African American" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         asian = ifelse(Race == "Asian" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         latinx = ifelse((!is.na(Hispanic) & Hispanic == "Yes"),1,0),
         nhpi = ifelse(Race == "Native Hawaiian or Other Pacific" & (is.na(Hispanic) | Hispanic == "No"),1,0),
         nat_am = ifelse(Race == "American Indian or Alaska Native" &
                           (is.na(Hispanic) | Hispanic == "No"),1,0),
         other = ifelse(is.na(Race) & (is.na(Hispanic) | Hispanic == "No"),1,0),
         stu_pct_white = mean(white, na.rm=TRUE)*100, #pct race/ethnicty for student-level data
         stu_pct_black = mean(black, na.rm=TRUE)*100,
         stu_pct_asian = mean(asian, na.rm=TRUE)*100,
         stu_pct_latinx = mean(latinx, na.rm=TRUE)*100,
         stu_pct_nhpi = mean(nhpi, na.rm=TRUE)*100,
         stu_pct_natam = mean(nat_am, na.rm=TRUE)*100,
         stu_pct_other = mean(other, na.rm=TRUE)*100,
         stu_pct_tot = stu_pct_white + stu_pct_black + stu_pct_asian + stu_pct_latinx + stu_pct_nhpi + stu_pct_natam + stu_pct_other)

```

<br>

**The table below compares the number of student's purchased for each high school (according to ncessch ID) and the racial/ethnic identities of those students to the racial/ethnic makeup of the school.**
```{r}
df_la_race <- df_sl_la_race %>%
       group_by(ncessch) %>%
       filter(row_number(ncessch) == 1) %>%
       arrange(-n_stu_nces) %>%
       select(ncessch, n_stu_nces, SName, stu_pct_white, pct_white, stu_pct_black, pct_black ,stu_pct_asian, pct_asian ,stu_pct_latinx, pct_hispanic, stu_pct_natam, pct_amerindian, stu_pct_other, pct_other)

df_la_race
```

**The table below sorts in descending order the number of students purchased by high school (according to ncessch ID) and shows the number of 11th and 12th graders enrolled (2018-2019 academic year), number of 11th & 12th grade test takers, and the number and percentage of test takers that met the benchmakrs for ERW and Math for the SAT.**  

- 11th graders in 2018-2019 are graduating class of 2020
- 12th graders in 2018-2019 are graduating class of 2019
- SAT benchmark for ERW is score of 480 and benchmark for Math is score of 530.
- For 11th graders benchmark for ERW is 460 and benchmark for Math is 510.
```{r}
df_la_county_per <- df_la_county %>%
  group_by(ncessch) %>%
  filter(row_number(ncessch) == 1, !is.na(CDS)) %>%
  select(ncessch, SName, n_stu_nces, Enroll1112, NumTSTTakr1112, NumERWBenchmark1112, PctERWBenchmark1112, NumMathBenchmark1112, PctMathBenchmark1112, TotNumBothBenchmark11, PctBothBenchmark1112) %>% 
  arrange(-n_stu_nces)

df_la_county_per
```

**Comments**

- The CA Department of Education separates SAT scores for ERW and Math, while order summaries combine both to filter for total SAT score.
- Might be tricky to identify what SAT ranges universities' filter for since we are comparing at the high school-level and separate orders could filter for different SAT ranges (e.g., students purchased from same high school may come from separate orders.)
    - Could perhaps identify a range for SAT filter a university uses since that usually doesn't vary much.