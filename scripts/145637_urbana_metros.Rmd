---
title: "University of Illinois - Urbana-Champaign"
urlcolor: blue
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    fig_caption: true
    highlight: tango
    theme: default
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(tibble.width = Inf, width = 10000, scipen = 999)

library(tidyverse)
library(readxl)
library(lubridate)
library(leaflet)
library(rgdal)
# library(raster)
library(formattable)
library(scales)
library(htmlwidgets)
library(shiny)
```

<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>

```{r include=FALSE}
load(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/145637_orders.RData'))
```

# RQ: What are the characteristics of student list purchases?

### OOS Order Category: By MSA 

3 of the 21 OOS orders were by MSA

  - 2 orders in 2019
  - 1 order in 2020

```{r include=FALSE}
OOS_msa_orders <- OOS_orders %>% filter(order_num %in% c('500590', '567376', '483751'))

OOS_msa_orders
```

They made **2** "OOS Regional MSA" orders **1** "Regional Counselor MSAs" order.

- They used the segment analysis from above
- A+/B- high school GPA
- MSAs from states: CA, TX, GA, FL, NY, NJ


<iframe src="https://mpatricia01.github.io/public_requests_eda/outputs/maps/map_msas.html" width="100%" height="800px"></iframe>


# RQ: What are the characteristics of students/schools included vs. not included in purchased lists? 

General observations  

- Of 121,110 students purchased between 2017-2020, 52,788 reside in California. About 44% of student purchased (*assuming students weren't purchased more than once).

- Of 52,788 students purchased in California, 19,071 were purchased in the LA metro area alone (36%).

## Zip code investigations
After merging CEEB and NCES data, there were 45,172 students purchased in California, 18,417 had zip codes that did not match the zip code for the high school they attended. Perhaps wehave zip codes of the home addresses of students purchased? 

![](https://mpatricia01.github.io/public_requests_eda/outputs/maps/zip_comparison.png)

- If we use zip code of students' households, then we can get more precise information about them at the zip code-level (e.g., median household income, race/ethnicity, education level).
- If we use zip code of the high school, we can use secondary high school data about performance and racial/ethnic composition of the high school.  
- Perhaps we could use both?

## Out-of-State, zip codes purchased in LA metro area vs. not purchased

<iframe src="https://mpatricia01.github.io/public_requests_eda/outputs/maps/map_la_metro.html" width="100%" height="800px"></iframe>

- If we select on the Number of students purchased button, we can see that more students are visted in zip codes with a smaller percentage of Black, Latinx, and Native American population and zip codes with overall higher median household income.   
- Notice that areas shaded in gray (NA) are zip codes where no students were purchased (~68 zip codes). Similarly, these zip codes tend to be home to more Black, Latinx, and Native American people and have a lower median household income.


## RQ: What are the characteristics of students included vs. not included in purchased lists in the LA metro area? 

```{r include=FALSE}
# use df of CA schools
df_sl_ca <- read_csv("../data/145637_list_ca.csv")

# uniquely identified by Ref ID
df_sl_ca %>%
  group_by(Ref) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)


length(unique(df_sl_ca$ZipCode))

df_sl_ca <- df_sl_ca %>%
  mutate(stu_zipcode = str_pad(str_sub(ZipCode, 1, 5), width = 5, pad = '0', side = 'left'))


zip_cbsa_data <- read_csv(url('https://raw.githubusercontent.com/cyouh95/third-way-report/master/assets/data/zip_code_cbsa.csv'))

# grab zip codes in LA msa
la_zip_codes <- (zip_cbsa_data %>% filter(cbsa_1 == '31080'))$zip_code

#filter student list df to zipcodes in LA metro area [student's home address]
df_sl_stu_la <- df_sl_ca %>% filter(stu_zipcode %in% la_zip_codes)

#-------------------------------------------------------------------
# read in acs, zip-code-level data
acs_race_zipcodes <- read_csv("../data/acs_race_zipcode.csv")

# filter for zip codes in LA msa
acs_race_zipcode_la <- acs_race_zipcodes %>% filter(zipcode %in% la_zip_codes)

typeof(acs_race_zipcode_la$zipcode) # double
typeof(df_sl_stu_la$stu_zipcode) #character

acs_race_zipcode_la$zipcode <- as.character(acs_race_zipcode_la$zipcode)

# merge census data with student list + hs data
df_stu_la_acs <- df_sl_stu_la %>% rename(zipcode=stu_zipcode) %>% right_join(acs_race_zipcode_la, by = "zipcode")

# get rid of sat/act for now
df_stu_la_acs <- df_stu_la_acs %>% dplyr::select(-(ceeb:counter), -contains("sat_"), -contains("act_"))

length(unique(df_stu_la_acs$zipcode)) #378 
sum(is.na(df_stu_la_acs$Ref)) #86 zip codes not purchased in LA msa

# check merge
anti_merge <- acs_race_zipcode_la %>% rename(stu_zipcode=zipcode) %>% anti_join(df_sl_stu_la, by = "stu_zipcode")
length(unique(anti_merge$stu_zipcode)) #86


# create count of zip codes at student's home address purchased
df_stu_la_acs <- df_stu_la_acs %>%
  group_by(zipcode) %>%
  mutate(n_per_zip = n()) %>%
  ungroup() %>%
  mutate(n_per_zip = ifelse(is.na(Ref),0,n_per_zip),
         zip_purchased = ifelse(is.na(Ref),0,1))


length(unique(df_stu_la_acs$zipcode)) #378
table(df_stu_la_acs$zip_purchased) #86 not purchased, 292 purchased

df_stu_la_acs %>%
  group_by(zipcode) %>%
  filter(zip_purchased==1) %>%
  count() #292 unique zip codes purchased

#check
df_stu_la_acs %>%
  filter(is.na(n_per_zip)) # looks good

df_stu_la_acs %>%
  filter(n_per_zip == 0) #86

# run Karina's analysis 
df_stu_la_acs %>%
  count(zip_purchased)

df_stu_la_acs %>%
  filter(is.na(Ref)) %>%
  dplyr::select(Ref, zipcode, pop_black)


# binary plots of 0/1 purchased variable by student's home address zip code
acs_race_zipcode_grouped <- df_stu_la_acs %>% 
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(zip_purchased, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct) %>%
  group_by(zip_purchased) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

```

All "non-purchased" zipcodes included below are zip codes that make up the LA metro area that were not purchased. 

- The zip code from the student lists was used here. In other words, zip code represents the zip code associated with students' address. 

  - Binary version of zip_purchased is problematic because of variation in number of students purchased by zip
```{r}
acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=median_household_income, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean median household income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_white_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_asian_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_hispanic_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") + 
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_black_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") + 
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 


```

```{r include=FALSE}
# of students purchased by zipcodes

# create var for race by high school
df_stu_la_acs %>%
  filter(n_per_zip==0) %>%
  count() #86 not purchased

df_stu_la_acs %>%
  filter(n_per_zip >=1 & n_per_zip<=10) %>%
  count() #308

df_stu_la_acs %>%
  filter(n_per_zip>=11 & n_per_zip<50) %>%
  count() #2208

df_stu_la_acs %>%
  filter(n_per_zip>=51 & n_per_zip<100) %>%
  count() #3858

df_stu_la_acs %>%
  filter(n_per_zip>=101 & n_per_zip<200) %>%
  count() #5028

df_stu_la_acs %>%
  filter(n_per_zip>=201 & n_per_zip<300) %>%
  count() #4784

df_stu_la_acs %>%
  filter(n_per_zip>=300) %>%
  count() #2806


lbls <- c('zero','1-10','11-50','51-100','101-200', '201-300','300+')

acs_race_zipcode <- df_stu_la_acs %>% mutate(purchased_num_cat =cut(n_per_zip, breaks=c(-Inf, 0, 10, 50, 100, 200, 300, +Inf),labels = lbls)) 

acs_race_zipcode %>% count(purchased_num_cat)

acs_race_zipcode_groupedv2 <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, purchased_num_cat) %>%
  group_by(purchased_num_cat) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

# purchased zipcodes
 acs_zip_pur_la <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
  group_by(zipcode) %>%
  filter(n_per_zip > 0) %>%
  summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(n_per_zip))

 
# non purchased zip codes
 acs_zip_npur_la <- acs_race_zipcode %>%
   mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
   dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
   group_by(zipcode) %>%
   filter(n_per_zip == 0) %>%
   summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(median_household_income))

```

Large variation in the number of students purchased by zip codes (student-level zip code) 
```{r}
acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=median_household_income, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") + 
  labs(x = "Number of students purchased by zip code",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_white_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_asian_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_hispanic_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 


acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_black_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 
```

The table below sorts the number of students purchased by zip code in descending order for LA msa.
```{r}
acs_zip_pur_la
```

The table below displays median income and race/ethicity characteristics of zip codes that were not purchased in the LA msa area.
```{r}
acs_zip_npur_la
```

## RQ: What are the characteristics of students included vs. not included in purchased lists in the NY metro area? 

- Similar to LA msa, I am using the zip code associated with the student list zip code (students' address).  

```{r include=FALSE}
#filter to students from NY
df_sl_ny <- lists_df_sat %>% filter(State=="NY")

# not uniquely identified by Ref ID, [LOOK AT KARINA'S CODE FOR CA SCHOOLS]
df_sl_ny %>%
  group_by(Ref) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)

View(df_sl_ny %>%
  group_by(Ref) %>%
    filter(row_number(Ref)==1))  #same students purchaseds by different orders, for now just keep one of them

# get rid of duplicates for now since we aren't focusing on order summaries
df_sl_ny_v2 <- df_sl_ny %>%
  group_by(Ref) %>%
  filter(row_number(Ref)==1)

# Create 5-digit zip code
df_sl_ny_v2 <- df_sl_ny_v2 %>%
  mutate(stu_zipcode = str_pad(str_sub(ZipCode, 1, 5), width = 5, pad = '0', side = 'left'))

# check
df_sl_ny_v2 %>% dplyr::select(ZipCode, stu_zipcode)

#NY MSA code, 35620
# grab zip codes in NY-NJ_PA msa
ny_zip_codes <- (zip_cbsa_data %>% filter(cbsa_1 == '35620'))$zip_code

#filter student lists to zip codes in NY msa area
df_sl_ny_msa <- df_sl_ny_v2 %>% filter(stu_zipcode %in% ny_zip_codes)

# Read in acs race data by zip code
# uniquely identified by zip code
acs_race_zipcodes %>%
  group_by(zipcode) %>%
  summarise(n_per_grp = n()) %>%
  count(n_per_grp)


# filter for zip codes in NY-NJ msa
acs_race_zipcode_ny <- acs_race_zipcodes %>% filter(zipcode %in% ny_zip_codes)

typeof(acs_race_zipcode_ny$zipcode) # double
typeof(df_sl_ny_msa$stu_zipcode) #character

acs_race_zipcode_ny$zipcode <- as.character(acs_race_zipcode_ny$zipcode)

# merge census data with student list + hs data
df_stu_ny_acs <- df_sl_ny_msa %>% rename(zipcode=stu_zipcode) %>% right_join(acs_race_zipcode_ny, by = "zipcode")

length(unique(df_stu_ny_acs$zipcode)) #593 
sum(is.na(df_stu_ny_acs$Ref)) #151 zip codes of student' homes not purchased in NY msa

# check merge
anti_merge <- acs_race_zipcode_ny %>% rename(stu_zipcode=zipcode) %>% anti_join(df_sl_ny_msa, by = "stu_zipcode")
length(unique(anti_merge$stu_zipcode)) #151


# create count of zip codes at student's home address purchased
df_stu_ny_acs <- df_stu_ny_acs %>%
  group_by(zipcode) %>%
  mutate(n_per_zip = n()) %>%
  ungroup() %>%
  mutate(n_per_zip = ifelse(is.na(Ref),0,n_per_zip),
         zip_purchased = ifelse(is.na(Ref),0,1))


table(df_stu_ny_acs$zip_purchased) #151 not purchased, 442 purchased

df_stu_ny_acs %>%
  group_by(zipcode) %>%
  filter(zip_purchased==1) %>%
  count() #442 unique zip codes purchased

#check
df_stu_ny_acs %>%
  filter(is.na(n_per_zip)) # looks good

df_stu_ny_acs %>%
  filter(n_per_zip == 0) #151

# binary plots of 0/1 purchased variable by student's home address zip code
acs_race_zipcode_grouped <- df_stu_ny_acs %>% 
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(zip_purchased, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct) %>%
  group_by(zip_purchased) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

```

- All "non-purchased" zipcodes included below are zip codes in the NY metro area where a student was not purchased. 

- The zip code from the student lists data set was used here. In other words, zip code represents the zip code associated with students' address. 

  - Binary version of zip_purchased is problematic because of variation in number of students purchased by zip
```{r}

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=median_household_income, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_white_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity",fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_asian_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity",fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_hispanic_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity",fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_black_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

```


```{r include=FALSE}
# create var for race by high school
df_stu_ny_acs %>%
  filter(n_per_zip==0) %>%
  count() #151 not purchased

df_stu_ny_acs %>%
  filter(n_per_zip >=1 & n_per_zip<=10) %>%
  count() #572

df_stu_ny_acs %>%
  filter(n_per_zip>=11 & n_per_zip<50) %>%
  count() #4037

df_stu_ny_acs %>%
  filter(n_per_zip>=51 & n_per_zip<100) %>%
  count() #5238

df_stu_ny_acs %>%
  filter(n_per_zip>=101 & n_per_zip<200) %>%
  count() #6746

df_stu_ny_acs %>%
  filter(n_per_zip>=201 & n_per_zip<300) %>%
  count() #3023

df_stu_ny_acs %>%
  filter(n_per_zip>=300) %>%
  count() #1413


lbls <- c('zero','1-10','11-50','51-100','101-200', '201-300','300+')

acs_race_zipcode <- df_stu_ny_acs %>% mutate(purchased_num_cat =cut(n_per_zip, breaks=c(-Inf, 0, 10, 50, 100, 200, 300, +Inf),labels = lbls)) 

acs_race_zipcode %>% count(purchased_num_cat)

acs_race_zipcode_groupedv2 <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, purchased_num_cat) %>%
  group_by(purchased_num_cat) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

# purchased zipcodes
 acs_zip_pur_ny <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
  group_by(zipcode) %>%
  filter(n_per_zip > 0) %>%
  summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(n_per_zip))

 
# non purchased zip codes
 acs_zip_npur_ny <- acs_race_zipcode %>%
   mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
   dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
   group_by(zipcode) %>%
   filter(n_per_zip == 0) %>%
   summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(median_household_income))

```

Following the same logic and plotting number of students purchased by zip code.

Large variation in the number of students purchased by zip codes (student-level zip code)
```{r}
acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=median_household_income, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
   labs(x = "Number of students purchased by zip code",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 


acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_white_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
   labs(x = "Number of students purchased by zip code",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 


acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_asian_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
   labs(x = "Number of students purchased by zip code",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_hispanic_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
   labs(x = "Number of students purchased by zip code",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_black_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
   labs(x = "Number of students purchased by zip code",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

```

The table below sorts the number of students purchased by zip code in descending order.
```{r}
acs_zip_pur_ny
```

The table below displays median income and race/ethnicity characteristics of zip codes that were not purchased in the NY metro area.
```{r}
acs_zip_npur_ny
```

## RQ: What are the characteristics of students included vs. not included in purchased lists in the Austin-Round Rock-San Marcos metro area? 

- Similar to LA & NY msa, I am using the zip code associated with the student list zip code (students' address). 

```{r include=FALSE}
# Student list data, only SAT 
lists_df_sat %>% filter(State=="TX") #23,533

#filter for students from NY
df_sl_tx <- lists_df_sat %>% filter(State=="TX")

# not uniquely identified by Ref ID
df_sl_tx %>%
  group_by(Ref) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)

df_sl_tx %>%
  group_by(Ref) %>%
  count() %>%
  filter(n > 1)

View(df_sl_tx %>%
  filter(duplicated(df_sl_tx$Ref))) # it seems that same students purchased by different orders, for now just keep one of them

# get rid of duplicates for now since we aren't focusing on order summaries
df_sl_tx_v2 <- df_sl_tx %>%
  group_by(Ref) %>%
  filter(row_number(Ref)==1)

# check
df_sl_tx_v2 %>%
  group_by(Ref) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp) #looks good


# Create 5-digit zip code
df_sl_tx_v2 <- df_sl_tx_v2 %>%
  mutate(stu_zipcode = str_pad(str_sub(ZipCode, 1, 5), width = 5, pad = '0', side = 'left'))

# check
df_sl_tx_v2 %>% dplyr::select(ZipCode, stu_zipcode)

# check that geomarket contains TX
sum(str_detect(df_sl_tx_v2$GeoMarket, "TX"), na.rm = T) #23387

# check which cities are purchased the most
df_sl_tx_v2 %>%
  group_by(City) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  dplyr::select(City, n_per_grp) %>% arrange(desc(n_per_grp)) #Austin and Houston

#Austin MSA code, 12420
# grab zip codes in Austin-Round Rock msa

austin_zip_codes <- (zip_cbsa_data %>% filter(cbsa_1 == '12420'))$zip_code

#filter student lists to zip codes in Dallas msa area
df_sl_austin_msa <- df_sl_tx_v2 %>% filter(stu_zipcode %in% austin_zip_codes)


# uniquely identified by zip code
acs_race_zipcodes %>%
  group_by(zipcode) %>%
  summarise(n_per_grp = n()) %>%
  count(n_per_grp)


# filter for zip codes in Dallas msa
acs_race_zipcode_austin <- acs_race_zipcodes %>% filter(zipcode %in% austin_zip_codes)

# check
df_sl_austin_msa %>%
  group_by(Ref) %>%
  summarize(n_per_grp = n()) %>%
  count(n_per_grp)

typeof(acs_race_zipcode_austin$zipcode) #double
typeof(df_sl_austin_msa$stu_zipcode) #character

acs_race_zipcode_austin$zipcode <- as.character(acs_race_zipcode_austin$zipcode)

# check unique zip codes
length(unique(df_sl_austin_msa$stu_zipcode)) #51

# merge census data with student list + hs data
df_stu_austin_acs <- df_sl_austin_msa %>% rename(zipcode=stu_zipcode) %>% right_join(acs_race_zipcode_austin, by = "zipcode")

length(unique(df_stu_austin_acs$zipcode)) #96
sum(is.na(df_stu_austin_acs$Ref)) #49 zip codes of student' homes not purchased in Austin msa


# check merge
anti_merge <- acs_race_zipcode_austin %>% rename(stu_zipcode=zipcode) %>% anti_join(df_sl_austin_msa, by = "stu_zipcode")
length(unique(anti_merge$stu_zipcode)) #49


# create count of zip codes at student's home address purchased
df_stu_austin_acs <- df_stu_austin_acs %>%
  group_by(zipcode) %>%
  mutate(n_per_zip = n()) %>%
  ungroup() %>%
  mutate(n_per_zip = ifelse(is.na(Ref),0,n_per_zip),
         zip_purchased = ifelse(is.na(Ref),0,1))


table(df_stu_austin_acs$zip_purchased) #49 not purchased, 3715 purchased

df_stu_austin_acs %>%
  group_by(zipcode) %>%
  filter(zip_purchased==1) %>%
  count() #47 unique zip codes purchased

#check
df_stu_austin_acs %>%
  filter(is.na(n_per_zip)) # looks good

df_stu_austin_acs %>%
  filter(n_per_zip == 0) #49

# binary plots of 0/1 purchased variable by student's home address zip code
acs_race_zipcode_grouped <- df_stu_austin_acs %>% 
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(zip_purchased, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct) %>%
  group_by(zip_purchased) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

```

- All "non-purchased" zipcodes included below are zip codes in the Austin metro area where a student was not purchased. 

- The zip code from the student lists was used here. In other words, zip code represents the zip code associated with students' address. 

  - Binary version of zip_purchased is problematic because of variation in number of students purchased by zip
  
```{r}

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=median_household_income, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_white_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity",fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_asian_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_hispanic_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_black_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  
```

```{r include=FALSE}
# create var for race by high school
df_stu_austin_acs %>%
  filter(n_per_zip==0) %>%
  count() #49 not purchased

df_stu_austin_acs %>%
  filter(n_per_zip >=1 & n_per_zip<=10) %>%
  count() #44

df_stu_austin_acs %>%
  filter(n_per_zip>=11 & n_per_zip<50) %>%
  count() #189

df_stu_austin_acs %>%
  filter(n_per_zip>=51 & n_per_zip<100) %>%
  count() #774

df_stu_austin_acs %>%
  filter(n_per_zip>=101 & n_per_zip<200) %>%
  count() #881

df_stu_austin_acs %>%
  filter(n_per_zip>=201 & n_per_zip<300) %>%
  count() #1149

df_stu_austin_acs %>%
  filter(n_per_zip>=300) %>%
  count() #678


lbls <- c('zero','1-10','11-50','51-100','101-200', '201-300','300+')

acs_race_zipcode <- df_stu_austin_acs %>% mutate(purchased_num_cat =cut(n_per_zip, breaks=c(-Inf, 0, 10, 50, 100, 200, 300, +Inf),labels = lbls)) 

acs_race_zipcode %>% count(purchased_num_cat)

acs_race_zipcode_groupedv2 <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, purchased_num_cat) %>%
  group_by(purchased_num_cat) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

# purchased zipcodes
 acs_zip_pur_austin <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
  group_by(zipcode) %>%
  filter(n_per_zip > 0) %>%
  summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(n_per_zip))

 
# non purchased zip codes
 acs_zip_npur_austin <- acs_race_zipcode %>%
   mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
   dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
   group_by(zipcode) %>%
   filter(n_per_zip == 0) %>%
   summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(median_household_income))
 
```

Following the same logic and plotting number of students purchased by their zip codes.

Large variation in the number of students purchased by zip codes (student-level zip code)

```{r}

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=median_household_income, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_white_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity",fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_asian_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_hispanic_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_black_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

```

The table below sorts in descending order the number of students purchased by zip code.  
```{r}
acs_zip_pur_austin 
```

The table below displays median income and race/ethnicity characteristics of zipcodes that were not purchased in the Austin metro area. 
```{r}
acs_zip_npur_austin
```


## RQ: What are the characteristics of students included vs. not included in purchased lists in the California? 

- Similar to LA msa, I am using the zip code associated with the student list zip code (students' address).  
```{r include=FALSE}
lists_df_sat %>%
  filter(Country == "United States") %>%
  group_by(State) %>%
  summarise(n_per_grp = n()) %>% arrange(desc(n_per_grp))


# Student list data, only SAT 
lists_df_sat %>% filter(State=="CA") #51,030

#filter for students from FL
df_sl_ca <- lists_df_sat %>% filter(State=="CA")


# not uniquely identified by Ref ID
df_sl_ca %>%
  group_by(Ref) %>%
  summarise(n_per_grp = n()) %>%
  ungroup() %>%
  count(n_per_grp)


# get rid of duplicates for now since we aren't focusing on order summaries
df_sl_ca_v2 <- df_sl_ca %>%
  group_by(Ref) %>%
  filter(row_number(Ref)==1)


# Create 5-digit zip code
df_sl_ca_v2 <- df_sl_ca_v2 %>%
  mutate(stu_zipcode = str_pad(str_sub(ZipCode, 1, 5), width = 5, pad = '0', side = 'left'))


typeof(acs_race_zipcodes$zipcode) #double
typeof(df_sl_ca_v2$stu_zipcode) #character

#filter for CA zip codes
acs_race_ca_zipcode <- acs_race_zipcodes %>% filter(state_fips_code==06)
acs_race_ca_zipcode$zipcode <- as.character(acs_race_ca_zipcode$zipcode)

# check unique zip codes
length(unique(df_sl_ca_v2$stu_zipcode)) #814

# merge census data with student list + hs data
df_stu_ca_acs <- df_sl_ca_v2 %>% rename(zipcode=stu_zipcode) %>% right_join(acs_race_ca_zipcode, by = "zipcode")

length(unique(df_stu_ca_acs$zipcode)) #1764
sum(is.na(df_stu_ca_acs$Ref)) #1009 zip codes of student' homes not purchased in Tampa msa


# check merge
anti_merge <- acs_race_ca_zipcode %>% rename(stu_zipcode=zipcode) %>% anti_join(df_sl_ca_v2, by = "stu_zipcode")
length(unique(anti_merge$stu_zipcode)) #1009


# create count of zip codes at student's home address purchased
df_stu_ca_acs <- df_stu_ca_acs %>%
  group_by(zipcode) %>%
  mutate(n_per_zip = n()) %>%
  ungroup() %>%
  mutate(n_per_zip = ifelse(is.na(Ref),0,n_per_zip),
         zip_purchased = ifelse(is.na(Ref),0,1))


table(df_stu_ca_acs$zip_purchased) #1009 not purchased, 50894 purchased

df_stu_ca_acs %>%
  group_by(zipcode) %>%
  filter(zip_purchased==1) %>%
  count() #755 unique zip codes purchased

#check
df_stu_ca_acs %>%
  filter(is.na(n_per_zip)) # looks good

df_stu_ca_acs %>%
  filter(n_per_zip == 0) #1009

# note to p: include this in .Rmd file
# quick table of demographics of zipcodes not purchased by Urbana in Dallas MSA
View(df_stu_ca_acs %>%
       filter(n_per_zip == 0 & zip_purchased == 0) %>%
       dplyr::select(zipcode, n_per_zip, zip_purchased, median_household_income, contains("15_19_pct")) %>%
       arrange(desc(median_household_income)))

View(df_stu_ca_acs %>%
       group_by(zipcode) %>%
       filter(row_number(zipcode) == 1 & zip_purchased == 1) %>%
       dplyr::select(zipcode, n_per_zip, zip_purchased, median_household_income, contains("15_19_pct")) %>%
       arrange(desc(n_per_zip)))


# binary plots of 0/1 purchased variable by student's home address zip code
acs_race_zipcode_grouped <- df_stu_ca_acs %>% 
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(zip_purchased, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct) %>%
  group_by(zip_purchased) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

```

- All "non-purchased" zipcodes included below are zip codes in the California where a student was not purchased. 

- The zip code from the student lists was used here. In other words, zip code represents the zip code associated with students' address. 

  - Binary version of zip_purchased is problematic because of variation in number of students purchased by zip
  
```{r}
acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=median_household_income, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_white_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_asian_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_hispanic_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_grouped %>%
  ggplot(aes(x=as.factor(zip_purchased), y=pop_black_15_19_pct, color=zip_purchased)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Non-purchased vs. Purchased zip codes",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 
```

```{r include=FALSE}
# create var for race by high school
df_stu_ca_acs %>%
  filter(n_per_zip==0) %>%
  count() #1009 not purchased

df_stu_ca_acs %>%
  filter(n_per_zip >=1 & n_per_zip<=10) %>%
  count() #885

df_stu_ca_acs %>%
  filter(n_per_zip>=11 & n_per_zip<50) %>%
  count() #5914

df_stu_ca_acs %>%
  filter(n_per_zip>=51 & n_per_zip<100) %>%
  count() #8442

df_stu_ca_acs %>%
  filter(n_per_zip>=101 & n_per_zip<200) %>%
  count() #10862

df_stu_ca_acs %>%
  filter(n_per_zip>=201 & n_per_zip<300) %>%
  count() #9004

df_stu_ca_acs %>%
  filter(n_per_zip>=300) %>%
  count() #15487


lbls <- c('zero','1-10','11-50','51-100','101-200', '201-300','300+')

acs_race_zipcode <- df_stu_ca_acs %>% mutate(purchased_num_cat =cut(n_per_zip, breaks=c(-Inf, 0, 10, 50, 100, 200, 300, +Inf),labels = lbls)) 

acs_race_zipcode %>% count(purchased_num_cat)

acs_race_zipcode_groupedv2 <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, purchased_num_cat) %>%
  group_by(purchased_num_cat) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)))

# purchased zipcodes
acs_zip_pur_ca <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
  group_by(zipcode) %>%
  filter(n_per_zip > 0) %>%
  summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(n_per_zip))

# non purchased zip codes
acs_zip_npur_ca <- acs_race_zipcode %>%
  mutate(median_household_income = ifelse(median_household_income==-666666666, NA, median_household_income)) %>%
  dplyr::select(n_per_zip, median_household_income, pop_white_15_19_pct, pop_black_15_19_pct, pop_hispanic_15_19_pct, pop_asian_15_19_pct, zipcode) %>%
  group_by(zipcode) %>%
  filter(n_per_zip == 0) %>%
  summarise_each(funs(mean(., na.rm = TRUE))) %>% arrange(desc(median_household_income))

```

Following the same logic and plotting number of students purchased by their zip codes.

Large variation in the number of students purchased by zip codes (student-level zip code)

```{r}
acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=median_household_income, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean median income") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_white_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent White") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_asian_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Asian") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_hispanic_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Hispanic") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none")  

acs_race_zipcode_groupedv2 %>%
  ggplot(aes(x=as.factor(purchased_num_cat), y=pop_black_15_19_pct, color=purchased_num_cat)) +
  geom_bar(stat="identity", fill="white") +  
  labs(x = "Number of students purchased by zip code",
       y = "Mean percent Black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "none") 

```

The table below sorts in descending order the number of students purchased by zip code. 
```{r}
acs_zip_pur_ca
```

The table below displays median income and race/ethnicity characteristics of zipcodes that were not purchased in California. 
```{r}
acs_zip_npur_ca
```

