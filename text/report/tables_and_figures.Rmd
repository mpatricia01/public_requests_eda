---
title: 'Tables & Figures'
output:
  pdf_document: default
---

```{r setup, include = F}
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = F, message = F, warning = F)
# webshot::install_phantomjs()

library(tidyverse)
library(gridExtra)
library(kableExtra)
library(scales)
library(leaflet)
library(rgdal)

data_dir <- file.path('..', '..', 'data')

load(file.path(data_dir, 'tbl_fig_data.RData'))
zip_shp <- readOGR(file.path(data_dir, 'cb_2018_us_zcta510_500k', 'cb_2018_us_zcta510_500k.shp'))

theme_set(
  theme(
    text = element_text(size = 7),
    panel.background = element_blank(),
    plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
    axis.ticks = element_blank(),
    axis.title = element_text(face = 'bold'),
    legend.title = element_text(face = 'bold'),
    legend.key.size = unit(0.3, 'cm')
  )
)
```

## Figure

```{r, fig.height = 5}
create_cb_figure <- function(categories, values, plot_title) {
  cb_fig_df <- data.frame(
    category = rep(categories, each = 2),
    subcategory = rep(c('Not Licensed', 'Gain from being Licensed'), length(categories)), 
    value = values
  )
  
  cb_fig_df$category <- factor(cb_fig_df$category, levels = categories)
  
  cb_fig_df %>%
    left_join(
      cb_fig_df %>%
        pivot_wider(id_cols = category, names_from = subcategory, values_from = value) %>%
        mutate(
          total = `Not Licensed` + `Gain from being Licensed`,
          pct_change = `Gain from being Licensed` / `Not Licensed` * 100
        ),
      by = 'category') %>% 
    ggplot(aes(x = category, y = value, fill = subcategory, width = 0.6)) +
    geom_bar(position = 'stack', stat = 'identity') +
    geom_text(aes(y = value, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', value), '%'), '')), color = '#444444', size = 2, position = position_stack(vjust = 0.5)) +
    geom_text(aes(y = total + 3, label = if_else(subcategory == 'Not Licensed', str_c('(', sprintf('%.1f', pct_change), '%)'), '')), color = '#444444', size = 2) +
    geom_text(aes(y = total + 7, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', `Gain from being Licensed`), 'pp'), '')), color = '#444444', size = 2) +
    ggtitle(plot_title) +
    xlab('') + ylab('') + 
    scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 80)) +
    scale_fill_manual(values = c('#ba9a88', '#bbcfd7')) +
    theme(
        plot.margin = margin(t = 0.6, unit = 'cm'),
        panel.grid.major.y = element_line(size = 0.1, color = 'gray'),
        legend.title = element_blank(),
        legend.position = 'bottom',
        legend.margin = margin(t = -0.5, unit = 'cm'),
        legend.text = element_text(margin = margin(r = 0.2, unit = 'cm'))
      ) +
      guides(fill = guide_legend(reverse = T))
}

grid.arrange(
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'HI/PI', 'White'),
    c(32.8, 8.3, 37.5, 5.7, 31.8, 7.8, 24.1, 8.3, 26.5, 6.3, 22.2, 5.8, 44.4, 9.6),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'White'),
    c(15.7, 4.9, 17.7, 5.0, 7.2, 2.9, 6.7, 2.9, 8.7, 4.2, 24.0, 6.7),
    'BA Completion within 4 Years'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(32.8, 8.3, 24.9, 10.1, 36.5, 11.0, 53.4, 10.1),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(15.7, 4.9, 13.6, 6.8, 21.3, 8.5, 39.9, 10.1),
    'BA Completion within 4 Years'
  ),
  ncol = 2
)
```

```{r, warning = F}
ipeds_df <- read_csv(file.path(data_dir, 'ipeds_data.csv'), na = 'NULL', col_types = c('unitid' = 'c', 'endyear' = 'c', 'satactcomp25' = 'n', 'satactcomp75' = 'n', 'freshoutstpct' = 'n', 'pgrnt_n' = 'n', 'cohortsfaef' = 'n')) %>% filter(endyear == '2017')
hd_df <- read_csv(file.path(data_dir, 'hd2017.csv'), col_types = c('UNITID' = 'c', 'SECTOR' = 'c', 'UGOFFER' = 'c', 'LOCALE' = 'c'))
carnegie_df <- read_csv(file.path(data_dir, 'carnegie_2018.csv'), col_types = c('UNITID' = 'c', 'BASIC2015' = 'c'))

univ_df <- hd_df %>% select(UNITID, INSTNM, STABBR, SECTOR, UGOFFER, LOCALE) %>% 
  left_join(carnegie_df %>% select(UNITID, BASIC2015), by = 'UNITID') %>% 
  filter(
    STABBR %in% c('CA', 'TX', 'IL', 'MN'),
    SECTOR == 1,
    UGOFFER == 1,
    !BASIC2015 %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14),
    !UNITID %in% c('488800', '229337', '229300', '228644', '416801', '228653')
  ) %>% 
  left_join(ipeds_df %>% select(unitid, satactcomp25, satactcomp75, tfuginst, tfugoutst, ugftptfreshtot, freshoutstpct, pgrnt_n, cohortsfaef, ugftptfreshwhmf, ugftptfreshblmf, ugftptfreshapmf, ugftptfreshhimf, ugftptfreshalmf), by = c('UNITID' = 'unitid')) %>% 
  mutate(
    system = case_when(
      str_detect(INSTNM, 'University of California') ~ 'UC',
      STABBR == 'CA' ~ 'CSU',
      str_detect(INSTNM, 'Texas A') | UNITID %in% c('228529', '227526') ~ 'TX A&M',
      str_detect(INSTNM, 'University of Houston') ~ 'U of Houston',
      str_detect(INSTNM, 'University of North Texas') ~ 'UNT',
      str_detect(INSTNM, 'University of Texas') ~ 'U of TX',
      UNITID %in% c('222831', '229115') ~ 'TX Tech',
      UNITID %in% c('226091', '227881', '228501', '228459') ~ 'TX State U',
      STABBR == 'TX' ~ 'Indy TX',
      str_detect(INSTNM, 'University of Illinois') ~ 'U of IL',
      str_detect(INSTNM, 'Southern Illinois University') ~ 'SIU',
      STABBR == 'IL' ~ 'IL State U',
      str_detect(INSTNM, 'University of Minnesota') ~ 'UMN',
      STABBR == 'MN' ~ 'MN State U'
    ),
    locale = str_sub(LOCALE, end = 1),
    locale_text = recode_factor(
      locale,
      `4` = 'Rural',
      `3` = 'Town',
      `2` = 'Suburban',
      `1` = 'City'
    ),
    carnegie = recode_factor(
      BASIC2015,
      `-2` = 'Unknown',
      `15` = 'Doctoral Universities: Highest Research Activity',
      `16` = 'Doctoral Universities: Higher Research Activity',
      `17` = 'Doctoral Universities: Moderate Research Activity',
      `18` = 'Master\'s Colleges & Universities: Larger Programs',
      `19` = 'Master\'s Colleges & Universities: Medium Programs',
      `20` = 'Master\'s Colleges & Universities: Small Programs',
      `21` = 'Baccalaureate Colleges: Arts & Sciences Focus',
      `22` = 'Baccalaureate Colleges: Diverse Fields',
      `26` = 'Special Focus Four-Year: Other Health Professions Schools'
    )
  )

univ_df$STABBR = factor(univ_df$STABBR, levels = c('IL', 'MN', 'CA', 'TX'))
univ_df$system = factor(univ_df$system, levels = c('U of IL', 'IL State U', 'SIU', 'UMN', 'MN State U', 'UC', 'CSU', 'U of TX', 'TX State U', 'TX A&M', 'U of Houston', 'UNT', 'TX Tech', 'Indy TX'))
```

## Figure

```{r, fig.height = 2}
univ_df %>% 
  group_by(STABBR, carnegie) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = count, y = STABBR, fill = carnegie, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(x = count, label = count), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  geom_text(data = univ_df %>% group_by(STABBR) %>% summarise(total = n()), aes(x = total + 1.8, y = STABBR, label = str_c('N=', total), fill = NULL), color = '#444444', size = 2) +
  xlab('') + ylab('') +
  scale_y_discrete(limits = rev) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 40)) +
  scale_fill_brewer(palette = 'Spectral', direction = -1, name = 'Carnegie classification') +
  theme(
    axis.text.x = element_blank()
  ) +
  guides(fill = guide_legend(reverse = T))
```

## Figure

```{r, fig.height = 2}
univ_df %>% 
  group_by(STABBR, locale_text) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = count, y = STABBR, fill = locale_text, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(x = count, label = count), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  geom_text(data = univ_df %>% group_by(STABBR) %>% summarise(total = n()), aes(x = total + 1.2, y = STABBR, label = str_c('N=', total), fill = NULL), color = '#444444', size = 2) +
  xlab('') + ylab('') +
  scale_y_discrete(limits = rev) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 40)) +
  scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = 'Locale') +
  theme(
    axis.text.x = element_blank()
  ) +
  guides(fill = guide_legend(reverse = T))
```

## Table

```{r}
univ_df %>%
  mutate(
    satactcomp25 = if_else(is.na(satactcomp25), '', prettyNum(round(satactcomp25, 0), ',')),
    satactcomp75 = if_else(is.na(satactcomp75), '', prettyNum(round(satactcomp75, 0), ',')),
    tfuginst = str_c('$', prettyNum(sprintf('%.2f', tfuginst), ',')),
    tfugoutst = str_c('$', prettyNum(sprintf('%.2f', tfugoutst), ',')),
    freshoutstpct = if_else(is.na(freshoutstpct), '', str_c(sprintf('%.1f', freshoutstpct * 100), '%')),
    pgrnt_p = if_else(is.na(pgrnt_n), '', str_c(sprintf('%.1f', pgrnt_n / cohortsfaef * 100), '%')),
    pctfreshwh = if_else(ugftptfreshtot == 0, '', str_c(sprintf('%.1f', ugftptfreshwhmf / ugftptfreshtot * 100), '%')), 
    pctfreshbl = if_else(ugftptfreshtot == 0, '', str_c(sprintf('%.1f', ugftptfreshblmf / ugftptfreshtot * 100), '%')), 
    pctfreshhi = if_else(ugftptfreshtot == 0, '', str_c(sprintf('%.1f', ugftptfreshhimf / ugftptfreshtot * 100), '%')), 
    pctfreshap = if_else(ugftptfreshtot == 0, '', str_c(sprintf('%.1f', ugftptfreshapmf / ugftptfreshtot * 100), '%')), 
    pctfreshal = if_else(ugftptfreshtot == 0, '', str_c(sprintf('%.1f', ugftptfreshalmf / ugftptfreshtot * 100), '%')),
    ugftptfreshtot = if_else(ugftptfreshtot == 0, '', prettyNum(ugftptfreshtot, ','))
  ) %>% 
  select(STABBR, system, INSTNM, carnegie, satactcomp25, satactcomp75, tfuginst, tfugoutst, ugftptfreshtot, freshoutstpct, pgrnt_p, pctfreshwh, pctfreshbl, pctfreshhi, pctfreshap, pctfreshal) %>% 
  arrange(STABBR, system, desc(carnegie), INSTNM) %>% 
  kable(booktabs = F, col.names = c('State', 'System', 'University', 'Carnegie', '25th pctl SAT/ACT', '75th pctl SAT/ACT', 'In-state tuition', 'Out-of-state tuition', '# Freshmen' , '% Out-of-state freshmen', '% Pell', '% White', '% Black', '% Latinx', '% Asian/PI', '% Non-resident alien')) %>%
  collapse_rows(columns = 1:2, latex_hline = 'custom', custom_latex_hline = 1:2, valign = 'middle') %>%
  kable_styling(latex_options = 'scale_down')
```

## Table

```{r}
appendix_df <- univ_df %>% 
  select(INSTNM, STABBR, system, carnegie, locale_text) %>% 
  mutate(
  'num_received_summary' = rep_len(c(T, F), 91),
  'num_not_received_summary' = rep_len(c(F, T), 91),
  'num_received_list' = rep_len(c(T, F), 91),
  'num_not_received_list' = rep_len(c(F, T), 91),
  'num_received_both' = rep_len(c(T, F), 91),
  'num_not_received_both' = rep_len(c(F, T), 91)
) 

appendix_df %>% 
  group_by(STABBR) %>% 
  summarise(
    'num_received_summary' = sum(num_received_summary),
    'num_not_received_summary' = sum(num_not_received_summary),
    'num_received_list' = sum(num_received_list),
    'num_not_received_list' = sum(num_not_received_list),
    'num_received_both' = sum(num_received_both),
    'num_not_received_both' = sum(num_not_received_both)
  ) %>% 
  kable(booktabs = T, col.names = c('State', '# received order summary', '# no order summary', '# received list', '# no list', '# received both', '# did not receive both'), align = rep('c', 7)) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = 'scale_down')
```

```{r, eval = F}
# 486 total order summaries
# 271 has list
# 215 missing list
orders_df %>% left_join(lists_df_summary, by = c('order_num' = 'ord_num')) %>% count(is.na(n))

# 1967325 total prospects
# 1803599 has order
# 163726 missing order
lists_df_summary %>% mutate(has_order = !is.na(ord_num)) %>% group_by(has_order) %>% summarise(n = sum(n))

lists_df_summary %>% mutate(has_order = !is.na(ord_num)) %>% group_by(has_order, univ_state) %>% summarise(n = sum(n))
lists_df_summary %>% mutate(has_order = !is.na(ord_num)) %>% group_by(has_order, univ_c15basic) %>% summarise(n = sum(n))
```

## Table

```{r}
data.frame(
  orders_total = orders_df %>% nrow(),
  orders_with_list = orders_df %>% left_join(lists_df_summary, by = c('order_num' = 'ord_num')) %>% filter(!is.na(n)) %>% nrow(),
  prospects_total = prettyNum(sum(lists_df_summary$n), ','),
  prospects_with_order = prettyNum(sum((lists_df_summary %>% filter(!is.na(ord_num)))$n), ',')
) %>% 
  kable(booktabs = T, col.names = c('# orders total', '# orders with list', '# prospects total', '# prospects with order'), align = rep('c', 4)) %>% 
  row_spec(0, bold = T) %>% 
  kable_styling(position = 'center')
```

## Figure

```{r, fig.height = 2}
lists_df_summary %>% 
  mutate(has_order = !is.na(ord_num)) %>% 
  group_by(has_order, univ_state, univ_c15basic) %>% 
  summarise(count = sum(n)) %>% 
  mutate(
    has_order = factor(has_order, levels = c(T, F)),
    univ_state = factor(as.character(univ_state), levels = c('TX', 'CA', 'MN', 'IL')),
    univ_c15basic = as_factor(univ_c15basic),
    carnegie = recode_factor(
      univ_c15basic,
      "Doctoral Universities: Highest Research Activity" = "Research Extensive",
      "Master's Colleges & Universities: Larger Programs" = "Master's",
      "Master's Colleges & Universities: Medium Programs" = "Master's",
      "Baccalaureate Colleges: Diverse Fields" = "Baccalaureate"
    )
  ) %>% 
  ggplot(aes(x = count, y = univ_state, fill = carnegie, alpha = has_order, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity') +
  xlab('Number of prospects') + ylab('') +
  scale_x_continuous(labels = label_number(suffix = 'K', scale = 1e-3), expand = expansion(mult = c(0, 0.05)), limits = c(0, 855000)) +
  scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = 'Carnegie classification') +
  scale_alpha_manual(values = c(0.6, 0.3), name = 'Has order summary') +
  guides(fill = guide_legend(reverse = T, order = 1, override.aes= list(alpha = 0.6)))
```

## Figure

```{r, fig.height = 2}
orders_df %>% 
  left_join(lists_df_summary %>% select(ord_num, n), by = c('order_num' = 'ord_num')) %>%
  mutate(has_list = !is.na(n)) %>% 
  group_by(has_list, univ_state, carnegie) %>% 
  summarise(count = n()) %>% 
  mutate(
    has_list = factor(has_list, levels = c(T, F)),
    univ_state = factor(as.character(univ_state), levels = c('TX', 'CA', 'MN', 'IL')),
    carnegie = factor(carnegie, levels = c("Research Extensive", "Master's", "Baccalaureate"))
  ) %>% 
  ggplot(aes(x = count, y = univ_state, fill = carnegie, alpha = has_list, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity') +
  xlab('Number of orders') + ylab('') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 301)) +
  scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = 'Carnegie classification') +
  scale_alpha_manual(values = c(0.6, 0.3), name = 'Has list') +
  guides(fill = guide_legend(reverse = T, order = 1, override.aes= list(alpha = 0.6)))
```

## Figure

```{r, fig.height = 3}
orders_fig_totals %>% 
  ggplot(aes(x = reorder(university, -total_students), y = total_students, fill = as_factor(carnegie), width = 0.8)) +
  geom_bar(stat = 'identity', alpha = 0.6) +
  geom_text(aes(label = str_replace(total_orders_st, '^1 orders', '1 order'), y = total_students + 2000), vjust = 0, size = 2, fontface = 'bold') +
  xlab('') + ylab('Total students') +
  scale_y_continuous(labels = label_number(suffix = 'K', scale = 1e-3)) +
  scale_fill_brewer(palette = 'YlGnBu', name = 'Carnegie classification') +
  theme(
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank()
  )
```

## Figure

```{r, fig.height = 3}
orders_filters1 %>% 
  ggplot(aes(x = reorder(filters, V1), y = V1)) +
  geom_bar(stat = 'identity', fill = '#d2c8bc') +
  geom_text(aes(label = percent), hjust = -0.1, colour = 'black', size = 2, fontface = 'bold') +
  xlab('') + ylab('Number of orders') +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  coord_flip()
```

## Table

```{r}
table_gpa %>% 
  mutate(
    pct_low = str_c(pct_low, '%'),
    pct_high = str_c(pct_high, '%')
  ) %>% 
  kable(booktabs = T, col.names = c('GPA', '# low', '% low', '# high', '% high'), align = c('l', rep('c', 4))) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Table

```{r}
orders_df %>%
  filter(nchar(state_name) > 0) %>% 
  mutate(
    state_name = case_when(
      str_detect(state_name, '\\|') ~ 'Multi-state', 
      state_name == 'California' ~ 'CA', 
      state_name == 'Texas' ~ 'TX', 
      state_name == 'Illinois' ~ 'IL', 
      T ~ state_name
    )
  ) %>% 
  group_by(univ_state, state_name) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  kable(booktabs = T, col.names = c('University state', 'Purchased state(s)', 'Count'), align = rep('c', 3)) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Figure

```{r, echo = F, out.width = '100%'}
knitr::include_graphics(file.path(data_dir, 'cluster_EN.png'))
knitr::include_graphics(file.path(data_dir, 'cluster_HS.png'))
```

## Table

```{r}
df_0 %>% 
  kable(booktabs = T, col.names = c('Filters', 'Count'), align = c('l', 'c')) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Figure

```{r, fig.height = 2.5}
df_rq2a_counts <- df_rq2a %>% 
  filter(row_subj == 'Total N') %>% 
  select(all_domestic, research_univ_instate, research_univ_outofstate, regional_univ_instate, regional_univ_outofstate) %>% 
  t()

df_rq2a_counts <- data.frame(df_rq2a_counts, row.names = rownames(df_rq2a_counts)) %>% 
  rownames_to_column(var = 'count_type') %>% 
  dplyr::rename(count = df_rq2a_counts) %>% 
  mutate(loc_type = 'Domestic') %>% 
  rbind(c('all_domestic', df_int2$n[[2]], 'International')) %>% 
  arrange(count_type, loc_type)

df_rq2a_counts$count <- as.numeric(df_rq2a_counts$count)
df_rq2a_counts$count_type <- factor(df_rq2a_counts$count_type, levels = rev(c('all_domestic', 'research_univ_instate', 'research_univ_outofstate', 'regional_univ_instate', 'regional_univ_outofstate')))
df_rq2a_counts$loc_type <- factor(df_rq2a_counts$loc_type, levels = rev(c('Domestic', 'International')))

df_rq2a_counts %>% 
  ggplot(aes(x = count_type, y = count, fill = loc_type, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(y = if_else(count_type != 'regional_univ_outofstate', count, count * 7), label = prettyNum(count, ',')), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  xlab('') + ylab('') +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 1968000)) +
  scale_fill_brewer(palette = 'YlGnBu', name = 'Locale') +
  theme(
    axis.text.x = element_blank(),
    legend.position = 'top'
  ) +
  guides(fill = guide_legend(reverse = T)) +
  coord_flip()
```

```{r}
create_rq2a_figure <- function(categories, legend_title) {
  df_rq2a_fig <- df_rq2a %>% 
    filter(row_subj %in% categories) %>% 
    select(row_subj, all_domestic, research_univ_instate, regional_univ_instate, research_univ_outofstate, regional_univ_outofstate) %>% 
    pivot_longer(-row_subj, names_to = 'pct_type', values_to = 'pct')
  
  df_rq2a_fig$pct_type <- factor(df_rq2a_fig$pct_type, levels = rev(c('all_domestic', 'research_univ_instate', 'regional_univ_instate', 'research_univ_outofstate', 'regional_univ_outofstate')))
  df_rq2a_fig$row_subj <- factor(df_rq2a_fig$row_subj, levels = rev(categories))
  
  df_rq2a_fig %>% 
    ggplot(aes(x = pct, y = pct_type, fill = row_subj, width = 0.6)) +
    geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
    geom_text(aes(x = pct, label = ifelse(pct > 1, round(pct, 0), '')), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
    xlab('') + ylab('') +
    scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 101)) +
    scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = legend_title) +
    theme(
      axis.text.x = element_blank()
    ) +
    guides(fill = guide_legend(reverse = T))
}
```

## Figure

```{r, fig.height = 2.3}
create_rq2a_figure(c('Pct White', 'Pct Black', 'Pct Latinx', 'Pct Asian', 'Pct NH/PI', 'Pct AI/AN', 'Pct Multiracial', 'Pct Race-No Response', 'Pct Race-Missing'), 'Race/ethnicity')
```

## Figure

```{r, fig.height = 2.5}
df_rq2a_income <- df_rq2a %>% 
  filter(row_subj == 'Median Household Income (mean)') %>% 
  select(all_domestic, in_state, out_of_state, research_univ_instate, research_univ_outofstate, regional_univ_instate, regional_univ_outofstate) %>% 
  t()

df_rq2a_income <- data.frame(df_rq2a_income, row.names = rownames(df_rq2a_income)) %>% 
  rownames_to_column(var = 'count_type') %>% 
  dplyr::rename(count = df_rq2a_income)

df_rq2a_income$count_type <- factor(df_rq2a_income$count_type, levels = rev(c('all_domestic', 'in_state', 'out_of_state', 'research_univ_instate', 'research_univ_outofstate', 'regional_univ_instate', 'regional_univ_outofstate')))

df_rq2a_income %>% 
  ggplot(aes(x = count, y = count_type, width = 0.6)) +
  geom_bar(stat = 'identity', fill = '#7FCDBB', alpha = 0.6) +
  geom_text(aes(x = count + 800, label = str_c('$', round(count / 1000, 0), 'K')), color = '#555555', size = 2, hjust = 0) +
  xlab('') + ylab('') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 110000)) +
  theme(
    axis.text.x = element_blank(),
    legend.position = 'top'
  ) +
  guides(fill = guide_legend(reverse = T))
```

## Figure

```{r, fig.height = 2.3}
create_rq2a_figure(c('Pct Public', 'Pct Private', 'Pct School Unknown'), 'School type')
```

## Figure

```{r}
zip_shp_purchased <- subset(zip_shp, str_detect(ZCTA5CE10, str_c('^', orders_df$zip_code %>% na.omit() %>% unique() %>% str_split('\\|') %>% unlist(), collapse = '|')))

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(data = zip_shp_purchased, stroke = F, fillOpacity = 0.8, smoothFactor = 0.2, color = 'gray')
```

## Figure

```{r, fig.height = 4}
table_texasam_zip$stu_race_cb <- factor(table_texasam_zip$stu_race_cb, levels = rev(c('AIAN', 'Asian', 'Black', 'Latinx', 'Multiracial', 'White')))

table_texasam_zip %>% 
  ggplot(aes(x = ppt_diff_stu_pop, y = zip_3digit, fill = stu_race_cb)) + 
  geom_bar(position = 'dodge', stat = 'identity') +
  scale_fill_brewer(palette = 'Set2', direction = -1, name = 'Race/ethnicity') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), breaks = seq(-50, 40, 10), limits = c(-50, 45)) +
  scale_y_discrete(limits = rev) +
  xlab('Percentage point difference') + ylab('3-digit zip code') +
  guides(fill = guide_legend(reverse = T))
```

## Figure

```{r, fig.height = 4}
table_texasam_zip_inc %>% 
  mutate(inc_diff_stu_pop = stu_mean_inc - pop_med_inc) %>% 
  ggplot(aes(x = inc_diff_stu_pop, y = zip_3digit, width = 0.3)) + 
  geom_bar(position = 'dodge', stat = 'identity', fill = '#7FCDBB', alpha = 0.6) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(-10001, 40001), labels = label_number(suffix = 'K', scale = 1e-3)) +
  scale_y_discrete(limits = rev) +
  xlab('Income difference ($)') + ylab('3-digit zip code') +
  guides(fill = guide_legend(reverse = T))
```
