---
title: 'Tables & Figures'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = F}
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(gridExtra)
library(kableExtra)
library(scales)

data_dir <- file.path('..', '..', 'data')

color_palette <- c('#ba9a88', '#bbcfd7')

load(file.path(data_dir, 'tbl_fig_data.RData'))

orders_df <- orders_df %>% 
  filter(univ_id != '104151') %>%
  mutate_if(is.character, list(~na_if(., ''))) 

lists_orders_zip_hs_df <- readRDS(file.path(data_dir, 'lists_orders_zip_hs_df.RDS'))
```

## Figure

```{r, fig.height = 5}
create_cb_figure <- function(categories, values, plot_title) {
  cb_fig_df <- data.frame(
    category = rep(categories, each = 2),
    subcategory = rep(c('Not Licensed', 'Gain from being Licensed'), length(categories)), 
    value = values
  )
  
  cb_fig_df$category <- factor(cb_fig_df$category, levels = categories)
  
  cb_fig_df %>%
    left_join(
      cb_fig_df %>%
        pivot_wider(id_cols = category, names_from = subcategory, values_from = value) %>%
        mutate(
          total = `Not Licensed` + `Gain from being Licensed`,
          pct_change = `Gain from being Licensed` / `Not Licensed` * 100
        ),
      by = 'category') %>% 
    ggplot(aes(x = category, y = value, fill = subcategory, width = 0.6)) +
    geom_bar(position = 'stack', stat = 'identity') +
    geom_text(aes(y = value, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', value), '%'), '')), color = '#444444', size = 2, position = position_stack(vjust = 0.5)) +
    geom_text(aes(y = total + 3, label = if_else(subcategory == 'Not Licensed', str_c('(', sprintf('%.1f', pct_change), '%)'), '')), color = '#444444', size = 2) +
    geom_text(aes(y = total + 7, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', `Gain from being Licensed`), 'pp'), '')), color = '#444444', size = 2) +
    ggtitle(plot_title) +
    xlab('') + ylab('') + 
    scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 80)) +
    scale_fill_manual(values = color_palette) +
    theme(
        text = element_text(size = 7),
        plot.margin = margin(t = 0.6, unit = 'cm'),
        plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
        panel.background = element_blank(),
        panel.grid.major.y = element_line(size = 0.1, color = 'gray'),
        axis.ticks = element_blank(),
        legend.title = element_blank(),
        legend.position = 'bottom',
        legend.margin = margin(t = -0.5, unit = 'cm'),
        legend.text = element_text(margin = margin(r = 0.2, unit = 'cm')),
        legend.key.size = unit(0.3, 'cm')
      ) +
      guides(fill = guide_legend(reverse = T))
}

grid.arrange(
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'HI/PI', 'White'),
    c(32.8, 8.3, 37.5, 5.7, 31.8, 7.8, 24.1, 8.3, 26.5, 6.3, 22.2, 5.8, 44.4, 9.6),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'White'),
    c(15.7, 4.9, 17.7, 5.0, 7.2, 2.9, 6.7, 2.9, 8.7, 4.2, 24.0, 6.7),
    'BA Completion within 4 Years'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(32.8, 8.3, 24.9, 10.1, 36.5, 11.0, 53.4, 10.1),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(15.7, 4.9, 13.6, 6.8, 21.3, 8.5, 39.9, 10.1),
    'BA Completion within 4 Years'
  ),
  ncol = 2
)
```

```{r, warning = F}
ipeds_df <- read_csv(file.path(data_dir, 'ipeds_data.csv'), na = 'NULL', col_types = c('unitid' = 'c', 'endyear' = 'c', 'satactcomp25' = 'n', 'satactcomp75' = 'n', 'freshoutstpct' = 'n', 'pgrnt_n' = 'n', 'cohortsfaef' = 'n')) %>% filter(endyear == '2017')
hd_df <- read_csv(file.path(data_dir, 'hd2017.csv'), col_types = c('UNITID' = 'c', 'SECTOR' = 'c', 'UGOFFER' = 'c', 'LOCALE' = 'c'))
carnegie_df <- read_csv(file.path(data_dir, 'carnegie_2018.csv'), col_types = c('UNITID' = 'c', 'BASIC2015' = 'c'))

univ_df <- hd_df %>% select(UNITID, INSTNM, STABBR, SECTOR, UGOFFER, LOCALE) %>% 
  left_join(carnegie_df %>% select(UNITID, BASIC2015), by = 'UNITID') %>% 
  filter(
    STABBR %in% c('CA', 'TX', 'IL', 'MN'),
    SECTOR == 1,
    UGOFFER == 1,
    !BASIC2015 %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14),
    !UNITID %in% c('488800', '229337', '229300', '228644', '416801', '228653')
  ) %>% 
  left_join(ipeds_df %>% select(unitid, satactcomp25, satactcomp75, tfuginst, tfugoutst, ugftptfreshtot, freshoutstpct, pgrnt_n, cohortsfaef, ugftptfreshwhmf, ugftptfreshblmf, ugftptfreshapmf, ugftptfreshhimf, ugftptfreshalmf), by = c('UNITID' = 'unitid')) %>% 
  mutate(
    system = case_when(
      str_detect(INSTNM, 'University of California') ~ 'UC',
      STABBR == 'CA' ~ 'CSU',
      str_detect(INSTNM, 'Texas A') | UNITID %in% c('228529', '227526') ~ 'TX A&M',
      str_detect(INSTNM, 'University of Houston') ~ 'U of Houston',
      str_detect(INSTNM, 'University of North Texas') ~ 'U of N. TX',
      str_detect(INSTNM, 'University of Texas') ~ 'U of TX',
      UNITID %in% c('222831', '229115') ~ 'TX Tech',
      UNITID %in% c('226091', '227881', '228501', '228459') ~ 'TX State U',
      STABBR == 'TX' ~ 'Indy TX',
      str_detect(INSTNM, 'University of Illinois') ~ 'U of IL',
      str_detect(INSTNM, 'Southern Illinois University') ~ 'SIU',
      STABBR == 'IL' ~ 'IL State U',
      str_detect(INSTNM, 'University of Minnesota') ~ 'UMN',
      STABBR == 'MN' ~ 'MN State U'
    ),
    locale = str_sub(LOCALE, end = 1),
    locale_text = recode_factor(
      locale,
      `4` = 'Rural',
      `3` = 'Town',
      `2` = 'Suburban',
      `1` = 'City'
    ),
    carnegie = recode_factor(
      BASIC2015,
      `-2` = 'Unknown',
      `15` = 'Doctoral Universities: Highest Research Activity',
      `16` = 'Doctoral Universities: Higher Research Activity',
      `17` = 'Doctoral Universities: Moderate Research Activity',
      `18` = 'Master\'s Colleges & Universities: Larger Programs',
      `19` = 'Master\'s Colleges & Universities: Medium Programs',
      `20` = 'Master\'s Colleges & Universities: Small Programs',
      `21` = 'Baccalaureate Colleges: Arts & Sciences Focus',
      `22` = 'Baccalaureate Colleges: Diverse Fields',
      `26` = 'Special Focus Four-Year: Other Health Professions Schools'
    )
  )
```

## Figure

```{r, fig.height = 2}
univ_df %>% 
  group_by(STABBR, carnegie) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = count, y = STABBR, fill = carnegie, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(x = count, label = count), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  geom_text(data = univ_df %>% group_by(STABBR) %>% summarise(total = n()), aes(x = total + 1.8, y = STABBR, label = str_c('N=', total), fill = NULL), color = '#444444', size = 2) +
  xlab('') + ylab('') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 40)) +
  scale_fill_brewer(palette = 'Spectral', direction = -1, name = 'Carnegie classification') +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm')
    ) +
    guides(fill = guide_legend(reverse = T))
```

## Figure

```{r, fig.height = 2}
univ_df %>% 
  group_by(STABBR, locale_text) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = count, y = STABBR, fill = locale_text, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(x = count, label = count), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  geom_text(data = univ_df %>% group_by(STABBR) %>% summarise(total = n()), aes(x = total + 1.2, y = STABBR, label = str_c('N=', total), fill = NULL), color = '#444444', size = 2) +
  xlab('') + ylab('') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 40)) +
  scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = 'Locale') +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm')
    ) +
    guides(fill = guide_legend(reverse = T))
```

## Table

```{r}
univ_df %>%
  mutate(
    pgrnt_p = pgrnt_n / cohortsfaef * 100,
    pctfreshwh = ugftptfreshwhmf / ugftptfreshtot * 100, 
    pctfreshbl = ugftptfreshblmf / ugftptfreshtot * 100, 
    pctfreshap = ugftptfreshapmf / ugftptfreshtot * 100, 
    pctfreshhi = ugftptfreshhimf / ugftptfreshtot * 100, 
    pctfreshal = ugftptfreshalmf / ugftptfreshtot * 100
  ) %>% 
  select(STABBR, system, INSTNM, satactcomp25, satactcomp75, tfuginst, tfugoutst, ugftptfreshtot, freshoutstpct, pgrnt_p, pctfreshwh, pctfreshbl, pctfreshap, pctfreshhi, pctfreshal) %>% 
  arrange(STABBR, system, INSTNM) %>% 
  kable(booktabs = F) %>%
  collapse_rows(columns = 1:2, latex_hline = 'custom', custom_latex_hline = 1:2, valign = 'middle') %>%
  kable_styling(latex_options = 'scale_down')
```

## Figure

```{r, fig.height = 3}
univ_data <- readRDS(file.path(data_dir, 'univ_data.RDS'))
orders_df %>% 
  group_by(univ_id) %>%
  summarise(
    total_orders = n(),
    total_students = sum(num_students, na.rm = T)
  ) %>% 
  mutate(
    university = as.factor(row_number()),
    total_orders = as.character(total_orders),
    total_orders_st = str_c(total_orders, ' orders')
  ) %>% 
  merge(
    univ_data %>% select(c15basic, univ_id, univ_name),
    by = 'univ_id',
    all.x = T
  ) %>%
  mutate(
    carnegie = recode_factor(
      as.numeric(c15basic),
      `22`= "Baccalaureate",
      `18`= "Master's",
      `19`= "Master's",
      `15`= "Research Extensive"
    )
  ) %>% 
  ggplot(aes(x = reorder(university, -total_students), y = total_students, fill = as_factor(carnegie), width = 0.8)) +
  geom_bar(stat = 'identity', alpha = 0.6) +
  geom_text(aes(label = str_replace(total_orders_st, '^1 orders', '1 order'), y = total_students + 2000), vjust = 0, size = 2, fontface = 'bold') +
  xlab('') + ylab('Total students') +
  scale_y_continuous(labels = label_number(suffix = 'K', scale = 1e-3)) +
  scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = 'Carnegie classification') +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.x = element_blank(),
      axis.title = element_text(face = 'bold'),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm')
    )
```

## Figure

```{r, fig.height = 3}
orders_filters <- orders_df %>% 
  select(hs_grad_class, zip_code, zip_code_file, state_name, cbsa_name, intl_region, segment, race_ethnicity, gender,sat_score_min, sat_score_max, sat_score_old_min, sat_score_old_max, psat_score_min, psat_score_max, psat_score_old_min, psat_score_old_max, gpa_low, gpa_high, rank_low, rank_high, geomarket, ap_scores) %>%
  mutate(
    hsgrad_class = ifelse(!is.na(hs_grad_class), 1, 0),
    zip = ifelse(!is.na(zip_code) | !is.na(zip_code_file), 1, 0),
    states_fil = ifelse(!is.na(state_name), 1, 0), 
    cbsa = ifelse(!is.na(cbsa_name), 1, 0), 
    intl = ifelse(!is.na(intl_region), 1, 0), 
    segment = ifelse(!is.na(segment), 1, 0), 
    race = ifelse(!is.na(race_ethnicity), 1, 0), 
    gender = ifelse(!is.na(gender), 1, 0), 
    sat = ifelse((!is.na(sat_score_min) | !is.na(sat_score_max) | !is.na(sat_score_old_min) | !is.na(sat_score_old_max)), 1, 0), 
    psat = ifelse((!is.na(psat_score_min) | !is.na(psat_score_max) | !is.na(psat_score_old_min) | !is.na(psat_score_old_max)), 1, 0), 
    gpa = ifelse((!is.na(gpa_low) | !is.na(gpa_high)), 1, 0), 
    rank = ifelse((!is.na(rank_low) | !is.na(rank_high)), 1, 0), 
    geomarket = ifelse(!is.na(geomarket), 1, 0), 
    ap_score = ifelse(!is.na(ap_scores), 1, 0)
  ) 
  
orders_filters1 <- orders_filters %>% 
  select(hsgrad_class, zip, states_fil, cbsa, intl, segment, race, gender, sat, psat, gpa, rank, geomarket, ap_score) %>%
  summarize_if(is.numeric, sum, na.rm = T)
        
orders_filters1 <- as.data.frame(t(orders_filters1))
orders_filters1$filters <- rownames(orders_filters1)

orders_filters1 <- orders_filters1 %>%
  mutate(
    percent = round((V1 / 486) * 100)
  )

orders_filters1$percent <- str_c(orders_filters1$percent, '%')
        
orders_filters1 %>% 
  ggplot(aes(x = reorder(filters, V1), y = V1)) +
  geom_bar(stat = 'identity', fill = '#d2c8bc') +
  geom_text(aes(label = percent), hjust = -0.1, colour = 'black', size = 2, fontface = 'bold') +
  xlab('') + ylab('Number of orders') +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.title = element_text(face = 'bold'),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm')
    ) +
  coord_flip()
```

## Table

```{r}
table_gpalow <- orders_df %>%
  group_by(gpa_low) %>%
  summarise(n_low = n()) %>%
  mutate(pct_low = round(n_low / sum(n_low) * 100, digits = 1))
        
table_gpahigh <- orders_df %>%
  group_by(gpa_high) %>%
  summarise(n_high = n()) %>%
  mutate(pct_high = round(n_high / sum(n_high) * 100, digits = 1))
                             
table_gpa <- merge(
  table_gpalow,
  table_gpahigh,
  by.x = 'gpa_low', 
  by.y = 'gpa_high', 
  all = T
) %>%
  rename(gpa = gpa_low) %>% 
  filter(nchar(gpa) > 0)

table_gpa %>% 
  mutate(
    pct_low = str_c(pct_low, '%'),
    pct_high = str_c(pct_high, '%')
  ) %>% 
  kable(booktabs = T, col.names = c('GPA', '# low', '% low', '# high', '% high'), align = c('l', rep('c', 4))) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Table

```{r}
orders_df %>%
  filter(nchar(state_name) > 0) %>% 
  mutate(
    state_name = case_when(
      str_detect(state_name, '\\|') ~ 'Multi-state', 
      state_name == 'California' ~ 'CA', 
      state_name == 'Texas' ~ 'TX', 
      state_name == 'Illinois' ~ 'IL', 
      T ~ state_name
    )
  ) %>% 
  group_by(univ_state, state_name) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  kable(booktabs = T, col.names = c('University state', 'Purchased state(s)', 'Count'), align = rep('c', 3)) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Figure

```{r, echo = F, out.width = '100%'}
knitr::include_graphics(file.path(data_dir, 'cluster_EN.png'))
knitr::include_graphics(file.path(data_dir, 'cluster_HS.png'))
```

## Table

```{r}
filter_combos <- orders_filters %>%
  select(hsgrad_class, zip, states_fil, cbsa, intl, segment, race, gender,sat, psat, gpa, rank, geomarket, ap_score) %>%
  mutate(
    filter_sum = hsgrad_class + zip + states_fil + cbsa + intl + segment + race + gender + sat + psat + gpa + rank + geomarket + ap_score,
    hsgrad_class = ifelse(hsgrad_class == 1, 'grad_class', NA),
    zip = ifelse(zip == 1, 'zip', NA),
    states_fil = ifelse(states_fil == 1, 'state', NA), 
    cbsa = ifelse(cbsa == 1, 'cbsa', NA), 
    intl = ifelse(intl == 1, 'intl', NA), 
    segment = ifelse(segment == 1, 'segment', NA), 
    race = ifelse(race == 1, 'race', NA), 
    gender = ifelse(gender == 1, 'gender', NA), 
    sat = ifelse(sat == 1, 'sat', NA), 
    psat = ifelse(psat == 1, 'psat', NA), 
    gpa = ifelse(gpa == 1, 'gpa', NA), 
    rank = ifelse(rank == 1, 'rank', NA), 
    geomarket = ifelse(geomarket == 1, 'geomarket', NA), 
    ap_score = ifelse(ap_score == 1, 'APscores', NA)
  )

filter_combos[filter_combos == 'NA'] <- NA_character_

df_0 <- group_by(filter_combos, hsgrad_class, zip, states_fil, cbsa, intl, segment, race, gender, sat, psat, gpa, rank, geomarket, ap_score) %>% 
  count() %>% 
  unite('string', c(hsgrad_class, zip, states_fil, cbsa, intl, segment, race, gender, sat, psat, gpa, rank, geomarket, ap_score), sep = ',', remove = T, na.rm = T) %>% 
  arrange(-n) %>% 
  head(10)
            
df_0 %>% 
  kable(booktabs = T, col.names = c('Filters', 'Count'), align = c('l', 'c')) %>% 
  row_spec(0, bold = T) %>%
  kable_styling(position = 'center')
```

## Figure

```{r}
table_rq2a <- function(variables, columns) {
            
    # Create counter
    counter = 0

    # Loop through columns via filters (ex. all students, in-state, out-state, etc.)
    for (i in columns) {
        
        counter = counter + 1
        
        if (i == 'all_domestic') {
         filter_string=c('stu_in_us==1')
        } else if (i == 'in_state') {
        filter_string=c('stu_nonres==0')
        } else if (i == 'out_of_state') {
        filter_string=c('stu_nonres==1')
        } else if (i == 'research_univ') {
        filter_string=c("stu_in_us==1 & univ_c15basic=='15'")
        } else if (i == 'regional_univ') {
        filter_string=c("stu_in_us==1 & univ_c15basic!='15'")
        } else if (i == "research_univ_instate") {
        filter_string=c("stu_in_us==1 & stu_nonres==0 & univ_c15basic=='15'")
        } else if (i == "research_univ_outofstate") {
        filter_string=c("stu_in_us==1 & stu_nonres==1 & univ_c15basic=='15'")
        } else if (i == "regional_univ_instate") {
        filter_string=c("stu_in_us==1 & stu_nonres==0 & univ_c15basic!='15'")
        } else if (i == "regional_univ_outofstate") {
        filter_string=c("stu_in_us==1 & stu_nonres==1 & univ_c15basic!='15'")
        }
        
        # Create N row
        n <- as_data_frame(t(lists_orders_zip_hs_df %>% filter(!! rlang::parse_expr(filter_string)) %>% count()))
        row.names(n) <- 'Total N'
        
        # Create race rows
        race <- lists_orders_zip_hs_df %>% 
          filter(!! rlang::parse_expr(filter_string)) %>%
          count(stu_race_cb) %>%
          mutate(V1 = n / sum(n) * 100) %>% 
          select(stu_race_cb, V1) %>% 
          mutate(
            stu_race_cb = ifelse(is.na(stu_race_cb), 'Pct- Race Missing', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 0, 'Pct Race-No Response', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 1, 'Pct AI/AN', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 2, 'Pct Asian', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 3, 'Pct Black', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 4, 'Pct Latinx', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 8, 'Pct NH/PI', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 9, 'Pct White', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 10, 'Pct Other Race', stu_race_cb),
            stu_race_cb = ifelse(stu_race_cb == 12, 'Pct Multiracial', stu_race_cb)
          ) %>% 
          remove_rownames() %>% 
          column_to_rownames(var = 'stu_race_cb')

        # Create income row
        income <- as_data_frame(t(lists_orders_zip_hs_df %>% filter(!! rlang::parse_expr(filter_string)) %>% summarise(mean_inc = mean(zip_median_household_income, na.rm = T))))
        row.names(income) <- 'Median Household Income (mean)'
        
        # Create school type rows
        schtype <- lists_orders_zip_hs_df %>% filter(!! rlang::parse_expr(filter_string)) %>%
          count(hs_school_control) %>%
          mutate(school_type = n / sum(n) * 100) %>% 
          select(hs_school_control, school_type) %>% 
          mutate(hs_school_control = ifelse(is.na(hs_school_control), 'school unknown', hs_school_control)) %>% 
          remove_rownames() %>% 
          column_to_rownames(var = 'hs_school_control') %>% 
          rename(V1 = school_type)
        row.names(schtype) <- c('Pct Private', 'Pct Public', 'Pct School Unknown')
        
        # Concatenate all row_dfs for i-column
        temp_df <- bind_rows(mget(variables))
        temp_df <- temp_df %>% rename(!!paste0('', i) := V1)
        temp_df <- rownames_to_column(temp_df, 'row_subj')

        # First loop creates the master_df
        # Second+ loops appends the master_df
        if (counter == 1){master_df <- as.data.frame(temp_df)}
        if (counter > 1){master_df <- merge(master_df,temp_df, by = 'row_subj', sort = F)}
    }

    return(master_df)
}
        

vars <- c('n', 'race', 'income', 'schtype')
cols <- c('all_domestic','in_state', 'out_of_state', 'research_univ', 'regional_univ', 'research_univ_instate', 'research_univ_outofstate', 'regional_univ_instate', 'regional_univ_outofstate') 

df_rq2a <- table_rq2a(vars, cols) 

df_int <- lists_orders_zip_hs_df %>% 
  filter(stu_country != 'united states') %>%
  group_by(stu_country) %>%
  summarise(n = n()) %>%
  mutate(pct = round(n / sum(n) * 100, digits = 1)) %>% 
  arrange(-n)
```

```{r, fig.height = 2.5}
df_rq2a_counts <- df_rq2a %>% 
  filter(row_subj == 'Total N') %>% 
  select(all_domestic, research_univ_instate, research_univ_outofstate, regional_univ_instate, regional_univ_outofstate) %>% 
  t()

df_rq2a_counts <- data.frame(df_rq2a_counts, row.names = rownames(df_rq2a_counts)) %>% 
  rownames_to_column(var = 'count_type') %>% 
  dplyr::rename(count = df_rq2a_counts) %>% 
  mutate(loc_type = 'Domestic') %>% 
  rbind(c('all_domestic', sum(df_int$n), 'International')) %>% 
  arrange(count_type, loc_type)

df_rq2a_counts$count <- as.numeric(df_rq2a_counts$count)
df_rq2a_counts$count_type <- factor(df_rq2a_counts$count_type, levels = rev(c('all_domestic', 'research_univ_instate', 'research_univ_outofstate', 'regional_univ_instate', 'regional_univ_outofstate')))
df_rq2a_counts$loc_type <- factor(df_rq2a_counts$loc_type, levels = rev(c('Domestic', 'International')))

df_rq2a_counts %>% 
  ggplot(aes(x = count_type, y = count, fill = loc_type, width = 0.6)) +
  geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
  geom_text(aes(y = if_else(count_type != 'regional_univ_outofstate', count, count * 7), label = prettyNum(count, ',')), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
  xlab('') + ylab('') +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 1967000)) +
  scale_fill_brewer(palette = 'YlGnBu', name = 'Locale') +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm'),
      legend.position = 'top'
    ) +
    guides(fill = guide_legend(reverse = T)) +
  coord_flip()
```

```{r}
create_rq2a_figure <- function(categories, legend_title) {
  df_rq2a_fig <- df_rq2a %>% 
    filter(row_subj %in% categories) %>% 
    select(row_subj, all_domestic, research_univ_instate, regional_univ_instate, research_univ_outofstate, regional_univ_outofstate) %>% 
    pivot_longer(-row_subj, names_to = 'pct_type', values_to = 'pct')
  
  df_rq2a_fig$pct_type <- factor(df_rq2a_fig$pct_type, levels = rev(c('all_domestic', 'research_univ_instate', 'regional_univ_instate', 'research_univ_outofstate', 'regional_univ_outofstate')))
  df_rq2a_fig$row_subj <- factor(df_rq2a_fig$row_subj, levels = rev(categories))
  
  df_rq2a_fig %>% 
    mutate(row_subj = recode(
      row_subj,
      'Pct- Race Missing' = 'Pct-Race Missing'
    )) %>% 
    ggplot(aes(x = pct, y = pct_type, fill = row_subj, width = 0.6)) +
    geom_bar(position = 'stack', stat = 'identity', alpha = 0.6) +
    geom_text(aes(x = pct, label = ifelse(pct > 1, round(pct, 0), '')), color = '#555555', size = 2, position = position_stack(vjust = 0.5)) +
    xlab('') + ylab('') +
    scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 101)) +
    scale_fill_brewer(palette = 'YlGnBu', direction = -1, name = legend_title) +
    theme(
        text = element_text(size = 7),
        plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        legend.title = element_text(face = 'bold'),
        legend.key.size = unit(0.3, 'cm')
      ) +
      guides(fill = guide_legend(reverse = T))
}
```

## Figure

```{r, fig.height = 2.3}
create_rq2a_figure(c('Pct White', 'Pct Black', 'Pct Latinx', 'Pct Asian', 'Pct NH/PI', 'Pct AI/AN', 'Pct Multiracial', 'Pct Race-No Response', 'Pct- Race Missing'), 'Race/ethnicity')
```

## Figure

```{r, fig.height = 2.5}
df_rq2a_income <- df_rq2a %>% 
  filter(row_subj == 'Median Household Income (mean)') %>% 
  select(all_domestic, in_state, out_of_state, research_univ_instate, research_univ_outofstate, regional_univ_instate, regional_univ_outofstate) %>% 
  t()

df_rq2a_income <- data.frame(df_rq2a_income, row.names = rownames(df_rq2a_income)) %>% 
  rownames_to_column(var = 'count_type') %>% 
  dplyr::rename(count = df_rq2a_income)

df_rq2a_income$count_type <- factor(df_rq2a_income$count_type, levels = rev(c('all_domestic', 'in_state', 'out_of_state', 'research_univ_instate', 'research_univ_outofstate', 'regional_univ_instate', 'regional_univ_outofstate')))

df_rq2a_income %>% 
  ggplot(aes(x = count, y = count_type, width = 0.6)) +
  geom_bar(stat = 'identity', fill = '#7FCDBB', alpha = 0.6) +
  geom_text(aes(x = count + 1000, label = str_c('$', round(count / 1000, 0), 'K')), color = '#555555', size = 2, hjust = 0) +
  xlab('') + ylab('') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 110000)) +
  theme(
      text = element_text(size = 7),
      plot.title = element_text(color = '#444444', size = 7, hjust = 0.5, face = 'bold'),
      panel.background = element_blank(),
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      legend.title = element_text(face = 'bold'),
      legend.key.size = unit(0.3, 'cm'),
      legend.position = 'top'
    ) +
    guides(fill = guide_legend(reverse = T))
```

## Figure

```{r, fig.height = 2.3}
create_rq2a_figure(c('Pct Public', 'Pct Private', 'Pct School Unknown'), 'School type')
```
